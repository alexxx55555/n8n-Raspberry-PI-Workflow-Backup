{
  "updatedAt": "2026-02-14T13:20:07.762Z",
  "createdAt": "2026-02-12T17:10:36.771Z",
  "id": "8g9lsHP5ix1pO0pB",
  "name": "AD Lockout Alertt with Slack Buttons",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "// 1. Get the raw output from PowerShell\nlet raw = $input.first().json.stdout;\nlet events = [];\n\n// 2. Parse the JSON string\nif (raw && typeof raw === 'string' && raw.trim() !== '') {\n  try {\n    let parsed = JSON.parse(raw);\n    events = Array.isArray(parsed) ? parsed : [parsed];\n  } catch (e) {\n    return [];\n  }\n}\n\n// 3. Map the data and fix the timestamp format\nreturn events.map(e => {\n  const d = new Date(e.Timestamp);\n  \n  // Build \"13.2.2026\"\n  const day = d.getDate();\n  const month = d.getMonth() + 1; // Months are 0-11, so we add 1\n  const year = d.getFullYear();\n  \n  // Build \"11:58 AM\"\n  let hours = d.getHours();\n  const minutes = d.getMinutes().toString().padStart(2, '0');\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  hours = hours % 12;\n  hours = hours ? hours : 12; // the hour '0' should be '12'\n  \n  // Combine them: \"13.2.2026 11:58 AM\"\n  const friendlyTime = `${day}.${month}.${year} ${hours}:${minutes} ${ampm}`;\n\n  return {\n    json: {\n      username: e.Username,\n      fullname: e.FullName,\n      computer: e.CallerComputer || 'UNKNOWN',\n      timestamp: friendlyTime \n    }\n  };\n});"
      },
      "id": "22376ec9-236d-4522-be39-57f01595d308",
      "name": "Parse AD Events",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36128,
        11616
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build the table rows as a clean string\nconst lockouts = $json.data;\nconst tableRows = lockouts.map((item, idx) => {\n  const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';\n  return `\n    <tr style=\"border-bottom: 1px solid #e0e0e0; background-color: ${bgColor};\">\n      <td style=\"padding: 14px 16px; font-family: sans-serif; font-size: 13px;\">${item.username}</td>\n      <td style=\"padding: 14px 16px; font-weight: 500;\">${item.fullname || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px;\"><span style=\"background-color: #fadbd8; color: #c0392b; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px;\">‚ö† Locked</span></td>\n      <td style=\"padding: 14px 16px;\">${item.computer || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px; color: #7f8c8d;\">${item.timestamp}</td>\n    </tr>`;\n}).join('');\n\nconst fullHtml = `\n<div style=\"font-family: sans-serif; color: #333; max-width: 900px;\">\n     <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 8px 8px 0 0;\">\n         <h2 style=\"margin: 0;\">üîê AD Account Lockouts</h2>\n         <p style=\"margin: 8px 0 0 0; opacity: 0.9;\">Live Status Monitor</p>\n     </div>\n     <div style=\"background: white; border: 1px solid #e0e0e0; border-radius: 0 0 8px 8px; overflow: hidden;\">\n         <table style=\"border-collapse: collapse; width: 100%;\">\n             <thead>\n                 <tr style=\"background-color: #f8f9fa; border-bottom: 2px solid #e0e0e0;\">\n                     <th style=\"padding: 16px; text-align: left;\">Username</th>\n                     <th style=\"padding: 16px; text-align: left;\">Full Name</th>\n                     <th style=\"padding: 16px; text-align: left;\">Status</th>\n                     <th style=\"padding: 16px; text-align: left;\">Source</th>\n                     <th style=\"padding: 16px; text-align: left;\">Last Check</th>\n                 </tr>\n             </thead>\n             <tbody>${tableRows}</tbody>\n         </table>\n     </div>\n     <div style=\"background: #f8f9fa; padding: 16px; text-align: right; font-size: 12px; color: #95a5a6;\">\n         <em>Generated via n8n</em>\n     </div>\n</div>`;\n\nreturn { \n  emailHtml: fullHtml,\n  lockoutCount: lockouts.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37008,
        11056
      ],
      "id": "73728333-bc2e-4d4c-8636-bcd19235bb2a",
      "name": "Build Email HTML"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        36624,
        11616
      ],
      "id": "b07ecf7d-60c0-4f2a-929b-75604666bd8d",
      "name": "Keep all incoming items"
    },
    {
      "parameters": {
        "jsCode": "const currentLockouts = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertTime = staticData.lastAlertTime || {};\n\nconst now = Date.now();\nconst FOUR_HOURS = 4 * 60 * 60 * 1000;\n\nconst newLockouts = currentLockouts.filter(item => {\n  const user = item.json.username;\n  const lastAlert = staticData.lastAlertTime[user];\n  \n  if (!lastAlert || (now - lastAlert) > FOUR_HOURS) {\n    staticData.lastAlertTime[user] = now;\n    return true;\n  }\n  return false;\n});\n\nreturn newLockouts;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36352,
        11616
      ],
      "id": "af2fadad-c53b-44d0-a080-3d627ce7321f",
      "name": "Check Memory"
    },
    {
      "parameters": {},
      "id": "6bc792b1-3c67-4a28-ab7d-664b1d951fb3",
      "name": "No Events",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        37504,
        11824
      ]
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "={{ \"üö® URGENT: \" + $json.lockoutCount + \" Account(s) Locked Out\" }}",
        "message": "={{ $json.emailHtml }}",
        "options": {}
      },
      "id": "132a2f56-49f3-4d0e-a4f6-cee639410242",
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        37376,
        11056
      ],
      "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.data.length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "617d808a-cb1a-4ecf-8d50-3602a630ec02",
      "name": "Any lockouts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        36896,
        11616
      ]
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Lockout-Monitor.ps1\"",
        "cwd": "="
      },
      "id": "6fb5a275-9336-4358-8fd6-3265ce6c830b",
      "name": "Run AD Lockout Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        35904,
        11616
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "fb6df397-49c3-4d8d-a2cc-fcdde4d8d2b1",
      "name": "Every 1 min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        35584,
        11616
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AEJQD4FA6"
            },
            {
              "name": "text",
              "value": "üö® AD Lockout Alert"
            },
            {
              "name": "blocks",
              "value": "={{ $json.blocks }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5115a453-08b1-4e86-b667-8e6d9cee9354",
      "name": "Send Slack (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        37936,
        11600
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputItems = $input.first().json;\nconst lockouts = inputItems.data ? inputItems.data : $input.all().map(i => i.json);\n\nconst blocks = [];\n\n// 1. HEADER\nblocks.push({\n  \"type\": \"header\",\n  \"text\": {\n    \"type\": \"plain_text\",\n    \"text\": `üö® AD LOCKOUT DETECTED (Total: ${lockouts.length})`,\n    \"emoji\": true\n  }\n});\n\n// 2. DIVIDER\nblocks.push({ \"type\": \"divider\" });\n\n// 3. LOOP THROUGH USERS\nlockouts.forEach((user) => {\n  \n  // Format Date\n  let timeStr = user.timestamp;\n  const d = new Date(user.timestamp);\n  if (!isNaN(d)) {\n    const datePart = `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;\n    let hours = d.getHours();\n    const minutes = d.getMinutes().toString().padStart(2, '0');\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; \n    timeStr = `${datePart} ${hours}:${minutes} ${ampm}`;\n  }\n\n  // 4. USER DETAILS\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `üë§ *Full Name:* ${user.fullname || 'Unknown'}\\nüÜî *Username:* \\`${user.username}\\`\\nüíª *Workstation:* \\`${user.computer || 'Unknown'}\\`\\nüìÖ *Timestamp:* ${timeStr}`\n    }\n  });\n\n  // 5. DIVIDER\n  blocks.push({ \"type\": \"divider\" });\n\n  // 6. ACTION TEXT (Now on ONE line)\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"üîì *Action:* Please investigate and unlock these accounts if required.\"\n    }\n  });\n\n  // 7. BUTTON (Sits below the text)\n  blocks.push({\n    \"type\": \"actions\",\n    \"elements\": [\n      {\n        \"type\": \"button\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"Unlock Account\",\n          \"emoji\": true\n        },\n        \"style\": \"primary\", // Green Button\n        \"action_id\": \"btn_unlock\",\n        \"value\": user.username\n      }\n    ]\n  });\n\n  // 8. FOOTER\n  blocks.push({\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ü§ñ Automated with this n8n workflow\"\n      }\n    ]\n  });\n\n  // Space between multiple users\n  if (lockouts.length > 1) {\n     blocks.push({ \"type\": \"divider\" });\n  }\n});\n\nreturn { blocks };"
      },
      "id": "8e6f6aca-8772-4694-87e2-c4602f1bd531",
      "name": "Build Slack Buttons",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        37488,
        11600
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action_id }}",
              "value2": "btn_unlock"
            }
          ]
        }
      },
      "id": "86d515cf-09d3-49ee-8b2d-70df9c82d781",
      "name": "Is Unlock?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        36384,
        11872
      ]
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/Unlock-ADAccount-n8n.ps1\" -Username \"{{ $json.username }}\"",
        "cwd": "="
      },
      "id": "0acdb2a5-0dfa-4233-b710-356a29e84666",
      "name": "Run Unlock Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        36736,
        11856
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AEJQD4FA6"
            },
            {
              "name": "attachments",
              "value": "=[\n  {\n    \"color\": \"#36a64f\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"‚úÖ Success: Account Enabled\",\n          \"emoji\": true\n        }\n      },\n      {\n        \"type\": \"section\",\n        \"text\": {\n          \"type\": \"mrkdwn\",\n          \"text\": \"The account has been enabled.\\n\\nüë§ *Account:* `{{ $node[\"Parse Click\"].json.username }}`\\nüõ°Ô∏è *Admin:* `{{ $node[\"Parse Click\"].json.adminUser }}`\"\n        }\n      },\n      {\n        \"type\": \"context\",\n        \"elements\": [\n          {\n            \"type\": \"plain_text\",\n            \"text\": \"Action logged via AD Admin Bot\",\n            \"emoji\": true\n          }\n        ]\n      }\n    ]\n  }\n]"
            }
          ]
        },
        "options": {}
      },
      "id": "fe030ef2-291e-4b0a-9fc5-49cb03ce25f3",
      "name": "Confirm Unlock",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        37056,
        11856
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack/interactive",
        "options": {}
      },
      "id": "325dde9e-245d-447b-8e5f-700bf6feddc3",
      "name": "Slack Button Handler",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        35584,
        11872
      ],
      "webhookId": "95df20d8-f2b4-48f5-adab-5f3e0675d0ce"
    },
    {
      "parameters": {
        "jsCode": "const payload = JSON.parse($input.first().json.body.payload);\nreturn {\n  action_id: payload.actions[0].action_id,\n  username: payload.actions[0].value,\n  adminUser: payload.user.name\n};"
      },
      "id": "248b9ba2-f4e2-4434-9eb8-4cc260216d60",
      "name": "Parse Click",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        36032,
        11872
      ]
    }
  ],
  "connections": {
    "Parse AD Events": {
      "main": [
        [
          {
            "node": "Check Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Keep all incoming items": {
      "main": [
        [
          {
            "node": "Any lockouts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Memory": {
      "main": [
        [
          {
            "node": "Keep all incoming items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email HTML": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any lockouts?": {
      "main": [
        [
          {
            "node": "Build Email HTML",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Slack Buttons",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run AD Lockout Script": {
      "main": [
        [
          {
            "node": "Parse AD Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 1 min": {
      "main": [
        [
          {
            "node": "Run AD Lockout Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Slack Buttons": {
      "main": [
        [
          {
            "node": "Send Slack (API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Unlock?": {
      "main": [
        [
          {
            "node": "Run Unlock Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Unlock Script": {
      "main": [
        [
          {
            "node": "Confirm Unlock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Button Handler": {
      "main": [
        [
          {
            "node": "Parse Click",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Click": {
      "main": [
        [
          {
            "node": "Is Unlock?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "Asia/Jerusalem",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Every 1 min1": {
      "recurrenceRules": []
    },
    "global": {
      "lastAlertTime": {
        "Steve": 1770973561780,
        "Tim": 1770973561780,
        "Ash": 1770973561780,
        "Pnina": 1770979346417,
        "shlomiv": 1770980819174,
        "pegyb": 1771010367249,
        "sunm": 1771068326320
      }
    },
    "node:Every 1 min": {
      "recurrenceRules": []
    },
    "node:Every 1 min2": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {},
  "versionId": "79a26dd3-e495-4ea4-95fc-7c647ffe7873",
  "activeVersionId": null,
  "triggerCount": 2,
  "shared": [
    {
      "updatedAt": "2026-02-12T17:10:36.774Z",
      "createdAt": "2026-02-12T17:10:36.774Z",
      "role": "workflow:owner",
      "workflowId": "8g9lsHP5ix1pO0pB",
      "projectId": "pWTWmuHnmIHw48U9"
    }
  ],
  "activeVersion": null,
  "tags": []
}