{
  "updatedAt": "2025-09-27T21:11:12.000Z",
  "createdAt": "2025-09-14T14:06:44.615Z",
  "id": "wwSwPmpbzl1DiAul",
  "name": "Disable AD User",
  "active": false,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\Scripts\\Disable-ADUser-From-n8n.ps1\" -Username \"{{$json[\"body\"][\"username\"]}}\"",
        "cwd": "="
      },
      "id": "81ffb333-6605-499d-bb72-6032654d3434",
      "name": "Disable AD User",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -11936,
        -10736
      ],
      "credentials": {
        "sshPassword": {
          "id": "79KNHZGwd8w288i9",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "f54ab6de-2566-4063-b57a-aa7fd93f51fb",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -13632,
        -10720
      ],
      "id": "ea83f994-7330-4143-90d1-29d5e10e2141",
      "name": "Webhook",
      "webhookId": "f54ab6de-2566-4063-b57a-aa7fd93f51fb"
    },
    {
      "parameters": {
        "jsCode": "/**\n * Allow this slash command only in #disable-ad-user\n */\nconst ALLOWED_CHANNEL_IDS = new Set(['C09GN391SQ6']);\nconst payload = $json.body ?? $json;\nconst channelId = payload.channel_id || payload.channel?.id || null;\nconst channelName = payload.channel_name || payload.channel?.name || null;\nlet authorized = false;\nlet errorMessage = '';\nif (channelId && ALLOWED_CHANNEL_IDS.has(channelId)) {\n  authorized = true;\n} else {\n  errorMessage = 'üö´ This command can only be used in #disable-ad-user';\n}\nreturn { ...$json, authorized, errorMessage, channelId, channelName };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -13120,
        -10720
      ],
      "id": "f73481af-9630-4480-b8cf-f636491b5c30",
      "name": "Authorization Check"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 1
          },
          "conditions": [
            {
              "id": "fbe754c6-374d-46bf-853c-84f7edfb467d",
              "leftValue": "={{$json.authorized}}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {
          "looseTypeValidation": true
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -12720,
        -10720
      ],
      "id": "143d9063-cd81-4491-9947-bf9bcb794174",
      "name": "IF Authorized"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{$json.errorMessage}}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -12432,
        -10416
      ],
      "id": "91dec564-a12e-42ba-9b74-fa4a36bc8367",
      "name": "Access Denied Response"
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "üîÑ Disabling user... please wait",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        -12432,
        -10736
      ],
      "id": "830c32c6-0810-40a4-b25e-f7df11876a09",
      "name": "Processing Response"
    },
    {
      "parameters": {
        "jsCode": "// Slack slash command input parser\nconst payload = $json.body ?? $json;\nconst raw = (payload.text ?? payload.username ?? '').trim();\nif (!raw) throw new Error('No username provided.');\nconst username = raw.replace(/^@/, '');\nreturn { body: { username } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -12192,
        -10736
      ],
      "id": "8ff99dff-563f-49d5-9e0d-69bc1761492a",
      "name": "Normalize input"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"No JSON output received from PowerShell script. Stdout was empty.\");\n}\ntry {\n  return JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -11632,
        -10736
      ],
      "id": "fe8c8fd5-4bdf-4379-9db9-7e85aa47bef8",
      "name": "AD Script Output Parser"
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "New AD user Created",
        "message": "={{$json[\"Status\"] === \"Not Found\" || $json[\"Status\"] === \"Error\" ? \"<h3 style='color:#d32f2f;'>\" + $json[\"Message\"] + \"</h3><p style='color:black; font-size:0.95em;'><b>üë§ Username:</b> \" + $json[\"Username\"] + \"</p>\" : \"<h2 style='color:red;'>üîí AD User \" + ($json[\"Status\"] === \"Already Disabled\" ? \"Already Disabled\" : \"Disabled\") + \"</h2><p style='color:black; font-size:0.95em;'><b>üë§ Username:</b> \" + $json[\"Username\"] + \"</p><p style='color:black; font-size:0.95em;'><b>üÜî Full Name:</b> \" + $json[\"FullName\"] + \"</p><p style='color:black; font-size:0.95em;'><b>üìå Status:</b> \" + $json[\"Status\"] + \"</p>\" + ($json[\"GroupsRemoved\"].length > 0 ? \"<p style='color:black; font-size:0.95em;'><b>üóëÔ∏è Groups Removed:</b> \" + $json[\"GroupsRemoved\"].join(\", \") + \"</p>\" : \"\") + ($json[\"MovedToOU\"] ? \"<p style='color:black; font-size:0.95em;'><b>üìÇ Moved To:</b> \" + $json[\"MovedToOU\"] + \"</p>\" : \"\")}}\n\n<hr>\n<p style=\"font-size:0.85em; color:gray;\">\n  Automated by n8n workflow\n</p>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        -10464,
        -10896
      ],
      "id": "6231b153-60fd-491e-8ec9-1d68a446c613",
      "name": "Send Message",
      "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1nh_eXCRjrbruYZWqF8_8LvW3TQ_d7EsN3bCQF_6Wfpg",
          "mode": "list",
          "cachedResultName": "New AD User Created",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nh_eXCRjrbruYZWqF8_8LvW3TQ_d7EsN3bCQF_6Wfpg/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "Sheet1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1nh_eXCRjrbruYZWqF8_8LvW3TQ_d7EsN3bCQF_6Wfpg/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "First Name": "={{$json[\"FirstName\"]}}",
            "Last Name": "={{$json[\"LastName\"]}}",
            "Job Title": "={{$json[\"JobTitle\"]}}\n",
            "Password": "={{$json[\"Password\"]}}",
            "Employee Number": "={{$json[\"EmployeeNumber\"]}}",
            "Department": "={{$json[\"Department\"]}}",
            "Manager": "={{$json[\"Manager\"]}}",
            "Office Location": "={{$json[\"OfficeLocation\"]}}",
            "Office Phone": "={{$json[\"OfficePhone\"]}}",
            "Username": "={{$json[\"Username\"]}}",
            "Email": "={{$json[\"Email\"]}}",
            "DL Groups Copied": "={{$json[\"DLGroupsCopied\"].join(', ')}}",
            "Security Groups Copied": "={{$json[\"SecurityGroupsCopied\"].join(', ')}}",
            "Conflict Message": "={{$json[\"ConflictMessage\"]}}",
            "Timestamp": "={{new Date().toLocaleString(\"en-GB\", { hour12: false, timeZone: \"Asia/Jerusalem\" })}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "Timestamp",
              "displayName": "Timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "First Name",
              "displayName": "First Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Last Name",
              "displayName": "Last Name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Employee Number",
              "displayName": "Employee Number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Job Title",
              "displayName": "Job Title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Department",
              "displayName": "Department",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Manager",
              "displayName": "Manager",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Office Location",
              "displayName": "Office Location",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Office Phone",
              "displayName": "Office Phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Username",
              "displayName": "Username",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Email",
              "displayName": "Email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "DL Groups Copied",
              "displayName": "DL Groups Copied",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Security Groups Copied",
              "displayName": "Security Groups Copied",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "Password",
              "displayName": "Password",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "Conflict Message",
              "displayName": "Conflict Message",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.6,
      "position": [
        -10448,
        -10672
      ],
      "id": "9c5cf7ef-bfd3-400d-8cf2-28c4bc034cd7",
      "name": "Append row in sheet",
      "executeOnce": false,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "MCeFqIGjffYKd95d",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "={{$json[\"Status\"] === \"Not Found\" || $json[\"Status\"] === \"Error\" ? $json[\"Message\"] + \"\\n\\nüë§ Username: \" + $json[\"Username\"] : \"üîí AD User \" + ($json[\"Status\"] === \"Already Disabled\" ? \"Already Disabled\" : \"Disabled\") + \"\\n\\nüë§ Username: \" + $json[\"Username\"] + \"\\nüÜî Full Name: \" + $json[\"FullName\"] + \"\\nüìå Status: \" + $json[\"Status\"] + ($json[\"GroupsRemoved\"].length > 0 ? \"\\nüóëÔ∏è Groups Removed: \" + $json[\"GroupsRemoved\"].join(', ') : \"\") + ($json[\"MovedToOU\"] ? \"\\nüìÇ Moved To: \" + $json[\"MovedToOU\"] : \"\")}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -10448,
        -10464
      ],
      "id": "ce563df4-076d-4707-9a68-b30e15e93312",
      "name": "Send a text message",
      "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "x7W5pZqq5q5bGRzU",
          "name": "Disable AD User"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C09GN391SQ6",
          "mode": "list",
          "cachedResultName": "disable-ad-user"
        },
        "text": "={{$json[\"Status\"] === \"Not Found\" || $json[\"Status\"] === \"Error\" ? $json[\"Message\"] + \"\\n\\nüë§ Username: \" + $json[\"Username\"] : \"üîí AD User \" + ($json[\"Status\"] === \"Already Disabled\" ? \"Already Disabled\" : \"Disabled\") + \"\\n\\nüë§ Username: \" + $json[\"Username\"] + \"\\nüÜî Full Name: \" + $json[\"FullName\"] + \"\\nüìå Status: \" + $json[\"Status\"] + ($json[\"GroupsRemoved\"].length > 0 ? \"\\nüóëÔ∏è Groups Removed: \" + $json[\"GroupsRemoved\"].join(', ') : \"\") + ($json[\"MovedToOU\"] ? \"\\nüìÇ Moved To: \" + $json[\"MovedToOU\"] : \"\")}}",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        -10448,
        -10240
      ],
      "id": "7958ceae-e580-46d9-9f73-3e8434612d00",
      "name": "Send a message",
      "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
      "credentials": {
        "slackApi": {
          "id": "ogd5puOuqvP7Ix28",
          "name": "Disable AD User"
        }
      }
    }
  ],
  "connections": {
    "Disable AD User": {
      "main": [
        [
          {
            "node": "AD Script Output Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Authorization Check",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Authorization Check": {
      "main": [
        [
          {
            "node": "IF Authorized",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Authorized": {
      "main": [
        [
          {
            "node": "Processing Response",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Access Denied Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processing Response": {
      "main": [
        [
          {
            "node": "Normalize input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalize input": {
      "main": [
        [
          {
            "node": "Disable AD User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AD Script Output Parser": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "1bca7085-b57c-474e-a554-28fc9d42be5f",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-31T09:14:00.838Z",
      "createdAt": "2025-10-31T09:14:00.838Z",
      "role": "workflow:owner",
      "workflowId": "wwSwPmpbzl1DiAul",
      "projectId": "pWTWmuHnmIHw48U9"
    }
  ],
  "tags": []
}