{
  "updatedAt": "2026-02-14T14:28:20.577Z",
  "createdAt": "2026-02-14T13:06:15.236Z",
  "id": "0fhPT29ipmgj83wO",
  "name": "AD Unlock & Reset Password",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "jsCode": "// 1. Get the raw output from PowerShell\nlet raw = $input.first().json.stdout;\nlet events = [];\n\n// 2. Parse the JSON string\nif (raw && typeof raw === 'string' && raw.trim() !== '') {\n  try {\n    let parsed = JSON.parse(raw);\n    events = Array.isArray(parsed) ? parsed : [parsed];\n  } catch (e) {\n    return [];\n  }\n}\n\n// 3. Map the data and fix the timestamp format\nreturn events.map(e => {\n  const d = new Date(e.Timestamp);\n  \n  // Build \"13.2.2026\"\n  const day = d.getDate();\n  const month = d.getMonth() + 1; // Months are 0-11, so we add 1\n  const year = d.getFullYear();\n  \n  // Build \"11:58 AM\"\n  let hours = d.getHours();\n  const minutes = d.getMinutes().toString().padStart(2, '0');\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  hours = hours % 12;\n  hours = hours ? hours : 12; // the hour '0' should be '12'\n  \n  // Combine them: \"13.2.2026 11:58 AM\"\n  const friendlyTime = `${day}.${month}.${year} ${hours}:${minutes} ${ampm}`;\n\n  return {\n    json: {\n      username: e.Username,\n      fullname: e.FullName,\n      computer: e.CallerComputer || 'UNKNOWN',\n      timestamp: friendlyTime \n    }\n  };\n});"
      },
      "id": "68755909-a9f0-4163-8bab-3ef4711e9075",
      "name": "Parse AD Events",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8000,
        -1264
      ]
    },
    {
      "parameters": {
        "jsCode": "// Build the table rows as a clean string\nconst lockouts = $json.data;\nconst tableRows = lockouts.map((item, idx) => {\n  const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';\n  return `\n    <tr style=\"border-bottom: 1px solid #e0e0e0; background-color: ${bgColor};\">\n      <td style=\"padding: 14px 16px; font-family: sans-serif; font-size: 13px;\">${item.username}</td>\n      <td style=\"padding: 14px 16px; font-weight: 500;\">${item.fullname || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px;\"><span style=\"background-color: #fadbd8; color: #c0392b; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px;\">‚ö† Locked</span></td>\n      <td style=\"padding: 14px 16px;\">${item.computer || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px; color: #7f8c8d;\">${item.timestamp}</td>\n    </tr>`;\n}).join('');\n\nconst fullHtml = `\n<div style=\"font-family: sans-serif; color: #333; max-width: 900px;\">\n     <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 8px 8px 0 0;\">\n         <h2 style=\"margin: 0;\">üîê AD Account Lockouts</h2>\n         <p style=\"margin: 8px 0 0 0; opacity: 0.9;\">Live Status Monitor</p>\n     </div>\n     <div style=\"background: white; border: 1px solid #e0e0e0; border-radius: 0 0 8px 8px; overflow: hidden;\">\n         <table style=\"border-collapse: collapse; width: 100%;\">\n             <thead>\n                 <tr style=\"background-color: #f8f9fa; border-bottom: 2px solid #e0e0e0;\">\n                     <th style=\"padding: 16px; text-align: left;\">Username</th>\n                     <th style=\"padding: 16px; text-align: left;\">Full Name</th>\n                     <th style=\"padding: 16px; text-align: left;\">Status</th>\n                     <th style=\"padding: 16px; text-align: left;\">Source</th>\n                     <th style=\"padding: 16px; text-align: left;\">Last Check</th>\n                 </tr>\n             </thead>\n             <tbody>${tableRows}</tbody>\n         </table>\n     </div>\n     <div style=\"background: #f8f9fa; padding: 16px; text-align: right; font-size: 12px; color: #95a5a6;\">\n         <em>Generated via n8n</em>\n     </div>\n</div>`;\n\nreturn { \n  emailHtml: fullHtml,\n  lockoutCount: lockouts.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7120,
        -1824
      ],
      "id": "391e9836-d320-4c89-b91f-0414239ac75d",
      "name": "Build Email HTML"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -7504,
        -1264
      ],
      "id": "54391d1c-e8da-421f-a7ba-2391780ec54b",
      "name": "Keep all incoming items"
    },
    {
      "parameters": {
        "jsCode": "const currentLockouts = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertTime = staticData.lastAlertTime || {};\n\nconst now = Date.now();\nconst FOUR_HOURS = 4 * 60 * 60 * 1000;\n\nconst newLockouts = currentLockouts.filter(item => {\n  const user = item.json.username;\n  const lastAlert = staticData.lastAlertTime[user];\n  \n  if (!lastAlert || (now - lastAlert) > FOUR_HOURS) {\n    staticData.lastAlertTime[user] = now;\n    return true;\n  }\n  return false;\n});\n\nreturn newLockouts;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7776,
        -1264
      ],
      "id": "814d196a-809a-47a8-a538-55cedd37660d",
      "name": "Check Memory"
    },
    {
      "parameters": {},
      "id": "a631ab5a-a2d3-477c-97ca-3bd202e3fdbf",
      "name": "No Events",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -6752,
        -1248
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ $json.data.length }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "a3d39e64-ea4e-4fd3-8c9c-656117e038b2",
      "name": "Any lockouts?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -7232,
        -1264
      ]
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Lockout-Monitor.ps1\"",
        "cwd": "="
      },
      "id": "2a4764c1-0ef9-4bba-b865-86ac7145cd4c",
      "name": "Run AD Lockout Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -8224,
        -1264
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "b3a8012f-a2e8-422e-94d1-83e0676d59fb",
      "name": "Every 1 min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -8544,
        -1264
      ]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -7424,
        -656
      ],
      "id": "ed6cd258-63f4-4246-ab7a-0a71bd59ea75",
      "name": "Aggregate All Items"
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Password-Expiry.ps1\"",
        "cwd": "="
      },
      "id": "d2d6a810-c6b6-45e5-8bea-32b4c1241ff1",
      "name": "Run Password Expiry Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -8224,
        -656
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Debug: Log raw output\nconst rawStdout = $input.first().json.stdout;\nconsole.log('Raw stdout:', rawStdout);\nconsole.log('Stdout type:', typeof rawStdout);\nconsole.log('Stdout length:', rawStdout ? rawStdout.length : 0);\n\n// Check if we have any output\nif (!rawStdout || rawStdout.trim() === '') {\n  console.error('No output from PowerShell script');\n  return { json: { data: [], error: 'No output from script', debug: 'Empty stdout' } };\n}\n\nlet parsedData = null;\n\ntry {\n  // Try to parse as JSON\n  parsedData = JSON.parse(rawStdout);\n  console.log('Successfully parsed JSON:', parsedData);\n} catch (parseError) {\n  console.error('JSON parse failed:', parseError.message);\n  console.error('Attempted to parse:', rawStdout.substring(0, 500));\n  \n  // Try to extract JSON from mixed output\n  const jsonMatch = rawStdout.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsedData = JSON.parse(jsonMatch[0]);\n      console.log('Extracted JSON from mixed output');\n    } catch (e) {\n      console.error('Failed to extract JSON:', e.message);\n      return { json: { data: [], error: 'Failed to parse JSON', raw: rawStdout.substring(0, 200) } };\n    }\n  } else {\n    return { json: { data: [], error: 'No JSON found in output', raw: rawStdout.substring(0, 200) } };\n  }\n}\n\n// Extract data array\nconst data = parsedData.Data || parsedData.data || [];\nconsole.log('Extracted data array, count:', data.length);\n\nif (!Array.isArray(data)) {\n  console.error('Data is not an array:', typeof data);\n  return { json: { data: [], error: 'Data is not an array' } };\n}\n\n// Return properly formatted items\nconst result = data.map((user, index) => {\n  console.log(`Processing user ${index}:`, user);\n  \n  return {\n    json: {\n      username: user.Username || user.username || '',\n      fullname: user.FullName || user.fullname || user.FullName || '',\n      email: user.Email || user.email || '',\n      expiryDate: user.ExpiryDate || user.expiryDate || '',\n      daysUntilExpiry: parseInt(user.DaysUntilExpiry || user.daysUntilExpiry || 0),\n      lastPasswordChange: user.LastPasswordChange || user.lastPasswordChange || '',\n      passwordNeverExpires: user.PasswordNeverExpires || user.passwordNeverExpires || false\n    }\n  };\n});\n\nconsole.log('Parsed result count:', result.length);\nif (result.length > 0) {\n  console.log('First result:', result[0]);\n}\n\nreturn result;"
      },
      "id": "718614b8-401f-4a60-9711-2f5056fa6b63",
      "name": "Parse Password Expiry Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7936,
        -656
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ Object.keys($json).length > 0 ? 1 : 0 }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "3b4d9ecd-c7de-4f93-8a70-bce1b1b19e32",
      "name": "Any expired/expiring?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -6864,
        -656
      ]
    },
    {
      "parameters": {
        "jsCode": "const currentUsers = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertedDate = staticData.lastAlertedDate || {};\n\nconst today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\nreturn currentUsers.filter(item => {\n  const user = item.json.username;\n  const lastDate = staticData.lastAlertedDate[user];\n\n  // Only alert once per day\n  if (lastDate !== today) {\n    staticData.lastAlertedDate[user] = today;\n    return true;\n  }\n  return false;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7664,
        -656
      ],
      "id": "1cbe159a-33c6-4c49-b84d-db30876d4bf2",
      "name": "Check Memory1"
    },
    {
      "parameters": {},
      "id": "f8a52b72-891f-4efe-8d3d-1b50ec83d526",
      "name": "No Events1",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -6560,
        -480
      ]
    },
    {
      "parameters": {
        "jsCode": "// Safely extract and aggregate data\nconst allItems = $input.all();\nconsole.log('Input items:', allItems.length);\n\nif (!allItems || allItems.length === 0) {\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Get the aggregated data\nconst firstItem = allItems[0].json;\nconsole.log('First item structure:', Object.keys(firstItem));\n\n// If data is already aggregated in json.data array\nlet usersData = [];\nif (firstItem.data && Array.isArray(firstItem.data)) {\n  usersData = firstItem.data;\n  console.log('Got users from data array:', usersData.length);\n} else if (firstItem.username) {\n  // Individual user items\n  usersData = allItems.map(item => item.json);\n  console.log('Got users from individual items:', usersData.length);\n}\n\nif (!usersData || usersData.length === 0) {\n  console.error('No user data found');\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Build HTML table\nconst tableRows = usersData.map(user => {\n  const daysLeft = parseInt(user.daysUntilExpiry || user.DaysUntilExpiry || 0);\n  const statusColor = daysLeft <= 0 ? '#e74c3c' : (daysLeft <= 3 ? '#e67e22' : (daysLeft <= 7 ? '#f39c12' : '#27ae60'));\n  const statusText = daysLeft <= 0 ? 'EXPIRED' : `${daysLeft} Days`;\n  const username = user.username || user.Username || '';\n  const fullname = user.fullname || user.FullName || '';\n  const email = user.email || user.Email || 'N/A';\n  const expiryDate = user.expiryDate || user.ExpiryDate || 'N/A';\n  \n  console.log(`Building row for ${username}: ${daysLeft} days`);\n  \n  return `\n    <tr style=\"border-bottom: 1px solid #eee;\">\n      <td style=\"padding: 12px; font-weight: 500;\">${username}</td>\n      <td style=\"padding: 12px;\">${fullname}</td>\n      <td style=\"padding: 12px;\">${email}</td>\n      <td style=\"padding: 12px; color: white; font-weight: bold; background-color: ${statusColor}; border-radius: 4px; text-align: center;\">\n        ${statusText}\n      </td>\n      <td style=\"padding: 12px;\">${expiryDate}</td>\n    </tr>`;\n}).join('');\n\nconst expiringCount = usersData.length;\nconst criticalCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 3).length;\nconst expiredCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 0).length;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .header { background-color: #2c3e50; color: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .header p { margin: 5px 0 0 0; opacity: 0.9; }\n    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n    .summary-card { background: white; padding: 15px; border-radius: 4px; border-left: 4px solid #3498db; }\n    .summary-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }\n    .summary-card .number { font-size: 32px; font-weight: bold; color: #2c3e50; }\n    .table-container { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .table-container h2 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }\n    table { width: 100%; border-collapse: collapse; }\n    th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-weight: bold; font-size: 14px; }\n    td { padding: 12px; }\n    .footer { text-align: center; color: #999; font-size: 12px; padding: 20px 0; border-top: 1px solid #eee; }\n    .warning { background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107; }\n    .warning strong { color: #856404; }\n    .warning ul { margin: 10px 0 0 0; padding-left: 20px; }\n    .warning li { margin: 5px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üîê Password Expiry Alert Report</h1>\n      <p>Generated: ${new Date().toLocaleString()}</p>\n    </div>\n    \n    <div class=\"summary\">\n      <div class=\"summary-card\">\n        <h3>Total Expiring</h3>\n        <div class=\"number\">${expiringCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #e74c3c;\">\n        <h3>Critical (‚â§3 days)</h3>\n        <div class=\"number\" style=\"color: #e74c3c;\">${criticalCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #c0392b;\">\n        <h3>Already Expired</h3>\n        <div class=\"number\" style=\"color: #c0392b;\">${expiredCount}</div>\n      </div>\n    </div>\n    \n    <div class=\"table-container\">\n      <h2>User Password Status</h2>\n      <table>\n        <thead>\n          <tr>\n            <th>Username</th>\n            <th>Full Name</th>\n            <th>Email</th>\n            <th>Status</th>\n            <th>Expiry Date</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${tableRows}\n        </tbody>\n      </table>\n    </div>\n    \n    <div class=\"warning\">\n      <strong>‚ö†Ô∏è Action Required:</strong>\n      <ul>\n        <li>Users with expiring passwords should reset them immediately</li>\n        <li>Expired passwords may result in account lockouts or login failures</li>\n        <li>Contact IT if unable to change password via self-service portal</li>\n        <li>IT Team: Verify script is running and users are receiving notifications</li>\n      </ul>\n    </div>\n    \n    <div class=\"footer\">\n      <p>This is an automated alert from Active Directory monitoring system.</p>\n      <p style=\"font-size: 11px; margin-top: 10px;\">If you believe this is in error, contact your IT department immediately.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nconsole.log('Built HTML email, user count:', expiringCount);\n\nreturn { json: { emailHtml: html, expiringCount: expiringCount, data: usersData } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7168,
        -656
      ],
      "id": "17513f60-bd0d-4e67-9e5d-f4b3664cd329",
      "name": "Build Email HTML1"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action_id }}",
              "value2": "btn_unlock"
            }
          ]
        }
      },
      "id": "a9c44825-bfdb-45a2-b870-a9114a9888ec",
      "name": "Is Unlock?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -7664,
        -304
      ]
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -Command \"$Username='{{ $json.username }}'; $NewPass='Temp' + (Get-Random -Minimum 1000 -Maximum 9999) + '!'; Set-ADAccountPassword -Identity $Username -NewPassword (ConvertTo-SecureString $NewPass -AsPlainText -Force) -Reset; Set-ADUser -Identity $Username -ChangePasswordAtLogon $true; Write-Output \\\"SUCCESS: Password for $Username reset to $NewPass\\\"\"",
        "cwd": "="
      },
      "id": "68497a96-583a-4729-8fa8-f2b71f0e5ab7",
      "name": "Execute Reset",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -7392,
        16
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/Unlock-ADAccount-n8n.ps1\" -Username \"{{ $json.username }}\"",
        "cwd": "="
      },
      "id": "a7a95b1d-640d-495b-bb22-a97ca24d2b60",
      "name": "Run Unlock Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -7344,
        -320
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const payload = JSON.parse($input.first().json.body.payload);\nreturn {\n  action_id: payload.actions[0].action_id,\n  username: payload.actions[0].value,\n  adminUser: payload.user.name\n};"
      },
      "id": "28e7365e-5250-4329-bc04-8eac1c5feaaf",
      "name": "Parse Click",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8112,
        -160
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "slack/interactive",
        "options": {}
      },
      "id": "193cd7c6-3e57-4bb7-81bf-c34dd0115e69",
      "name": "Slack Button Handler",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        -8576,
        -160
      ],
      "webhookId": "95df20d8-f2b4-48f5-adab-5f3e0675d0ce"
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.action_id }}",
              "value2": "btn_reset_password"
            }
          ]
        }
      },
      "id": "f8d18adc-d722-44ab-b0a0-51239214f6e4",
      "name": "Is Reset?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -7680,
        32
      ]
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "={{ \"üö® URGENT: \" + $json.lockoutCount + \" Account(s) Locked Out\" }}",
        "message": "={{ $json.emailHtml }}",
        "options": {}
      },
      "id": "5e3d6ab7-4cc9-493e-bf53-b52cfb4a0a9e",
      "name": "Send Unlcoked Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        -6752,
        -1824
      ],
      "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AEJQD4FA6"
            },
            {
              "name": "text",
              "value": "üö® AD Lockout Alert"
            },
            {
              "name": "blocks",
              "value": "={{ $json.blocks }}"
            }
          ]
        },
        "options": {}
      },
      "id": "09d668bb-c68a-42bf-91df-3c64852868f3",
      "name": "Send Slack Unlock Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -6512,
        -1472
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "={{ \"üîê ALERT: \" + $json.expiringCount + \" Password(s) Expiry Alert!\" }}",
        "message": "={{ $json.emailHtml }}",
        "options": {}
      },
      "id": "0f79f4c4-92b9-4cd3-b710-5f457c757762",
      "name": "Send Password Expiry Alert",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        -6752,
        -1056
      ],
      "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AE6LM59QF"
            },
            {
              "name": "text",
              "value": "üö® AD Lockout Alert"
            },
            {
              "name": "blocks",
              "value": "={{ $json.blocks }}"
            }
          ]
        },
        "options": {}
      },
      "id": "ce03e361-2e00-4838-9db3-d0b57177c84d",
      "name": "Send Password Expiry Alert Slack",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -6272,
        -672
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputItems = $input.first().json;\nconst lockouts = inputItems.data ? inputItems.data : $input.all().map(i => i.json);\n\nconst blocks = [];\n\n// 1. HEADER\nblocks.push({\n  \"type\": \"header\",\n  \"text\": {\n    \"type\": \"plain_text\",\n    \"text\": `üö® AD LOCKOUT DETECTED (Total: ${lockouts.length})`,\n    \"emoji\": true\n  }\n});\n\n// 2. DIVIDER\nblocks.push({ \"type\": \"divider\" });\n\n// 3. LOOP THROUGH USERS\nlockouts.forEach((user) => {\n  \n  // Format Date\n  let timeStr = user.timestamp;\n  const d = new Date(user.timestamp);\n  if (!isNaN(d)) {\n    const datePart = `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;\n    let hours = d.getHours();\n    const minutes = d.getMinutes().toString().padStart(2, '0');\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; \n    timeStr = `${datePart} ${hours}:${minutes} ${ampm}`;\n  }\n\n  // 4. USER DETAILS\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `üë§ *Full Name:* ${user.fullname || 'Unknown'}\\nüÜî *Username:* \\`${user.username}\\`\\nüíª *Workstation:* \\`${user.computer || 'Unknown'}\\`\\nüìÖ *Timestamp:* ${timeStr}`\n    }\n  });\n\n  // 5. DIVIDER\n  blocks.push({ \"type\": \"divider\" });\n\n  // 6. ACTION TEXT (Now on ONE line)\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"üîì *Action:* Please investigate and unlock these accounts if required.\"\n    }\n  });\n\n  // 7. BUTTON (Sits below the text)\n  blocks.push({\n    \"type\": \"actions\",\n    \"elements\": [\n      {\n        \"type\": \"button\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"Unlock Account\",\n          \"emoji\": true\n        },\n        \"style\": \"primary\", // Green Button\n        \"action_id\": \"btn_unlock\",\n        \"value\": user.username\n      }\n    ]\n  });\n\n  // 8. FOOTER\n  blocks.push({\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ü§ñ Automated with this n8n workflow\"\n      }\n    ]\n  });\n\n  // Space between multiple users\n  if (lockouts.length > 1) {\n     blocks.push({ \"type\": \"divider\" });\n  }\n});\n\nreturn { blocks };"
      },
      "id": "8c193273-9972-48fd-bbb8-890de9ab7aaa",
      "name": "Slack Buttons",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6768,
        -1472
      ]
    },
    {
      "parameters": {
        "jsCode": "const inputItems = $input.first().json;\nconst lockouts = inputItems.data ? inputItems.data : $input.all().map(i => i.json);\n\nconst blocks = [];\n\n// 1. HEADER\nblocks.push({\n  \"type\": \"header\",\n  \"text\": {\n    \"type\": \"plain_text\",\n    \"text\": `üö® AD ACCOUNT ALERT (Total: ${lockouts.length})`,\n    \"emoji\": true\n  }\n});\n\n// 2. DIVIDER\nblocks.push({ \"type\": \"divider\" });\n\n// 3. LOOP THROUGH USERS\nlockouts.forEach((user) => {\n  \n  // Format Date\n  let timeStr = user.timestamp;\n  const d = new Date(user.timestamp);\n  if (!isNaN(d)) {\n    const datePart = `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;\n    let hours = d.getHours();\n    const minutes = d.getMinutes().toString().padStart(2, '0');\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; \n    timeStr = `${datePart} ${hours}:${minutes} ${ampm}`;\n  }\n\n  // 4. USER DETAILS\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `üë§ *Full Name:* ${user.fullname || 'Unknown'}\\nüÜî *Username:* \\`${user.username}\\`\\nüíª *Workstation:* \\`${user.computer || 'Unknown'}\\`\\nüìÖ *Timestamp:* ${timeStr}`\n    }\n  });\n\n  // 5. DIVIDER\n  blocks.push({ \"type\": \"divider\" });\n\n  // 6. ACTION TEXT (Updated for Reset)\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"üîê *Action:* Resetting will set a temp password and force a change at next login.\"\n    }\n  });\n\n  // 7. BUTTON (Updated to Reset Password)\n  blocks.push({\n    \"type\": \"actions\",\n    \"elements\": [\n      {\n        \"type\": \"button\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"Reset Password\",\n          \"emoji\": true\n        },\n        \"style\": \"danger\", // Red Button for a more sensitive action\n        \"action_id\": \"btn_reset_password\", // Matches the IF node logic\n        \"value\": user.username\n      }\n    ]\n  });\n\n  // 8. FOOTER\n  blocks.push({\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ü§ñ Automated with AD Admin Bot\"\n      }\n    ]\n  });\n\n  // Space between multiple users\n  if (lockouts.length > 1) {\n     blocks.push({ \"type\": \"divider\" });\n  }\n});\n\nreturn { blocks };"
      },
      "id": "752fc1b3-bd26-4b8c-8476-0d3f788e78dd",
      "name": "Build Slack Buttons",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6544,
        -672
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AEJQD4FA6"
            },
            {
              "name": "attachments",
              "value": "=[\n  {\n    \"color\": \"#36a64f\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"‚úÖ Success: Account Unlocked!\",\n          \"emoji\": true\n        }\n      },\n      {\n        \"type\": \"section\",\n        \"text\": {\n          \"type\": \"mrkdwn\",\n          \"text\": \"The account has been Unlocked!\\n\\nüë§ *Account:* `{{ $node[\"Parse Click\"].json.username }}`\\nüõ°Ô∏è *Admin:* `{{ $node[\"Parse Click\"].json.adminUser }}`\"\n        }\n      },\n      {\n        \"type\": \"context\",\n        \"elements\": [\n          {\n            \"type\": \"plain_text\",\n            \"text\": \"Action logged via AD Admin Bot\",\n            \"emoji\": true\n          }\n        ]\n      }\n    ]\n  }\n]"
            }
          ]
        },
        "options": {}
      },
      "id": "b3ab4ffa-39f2-4de3-8068-460a8ccded37",
      "name": "Confirm Unlock",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -7120,
        -320
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "34d09486-add7-4879-9370-88422bcf893a",
      "name": "Every 12 hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -8624,
        -656
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://slack.com/api/chat.postMessage",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "slackApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "channel",
              "value": "C0AE6LM59QF"
            },
            {
              "name": "text",
              "value": "={{ \n  \"üîê *Password Reset Success*\\n\\n\" + \n  \"üë§ *Account:* `\" + $node[\"Execute Reset\"].json.username + \"`\\n\" +\n  \"üîë *New Temp Password:* `\" + $node[\"Execute Reset\"].json.stdout.split('to ')[1] + \"`\\n\" +\n  \"üõ°Ô∏è *Admin:* `\" + $node[\"Parse Click1\"].json.adminUser + \"`\\n\\n\" +\n  \"‚ö†Ô∏è _User is forced to change password at next login._\"\n}}"
            }
          ]
        },
        "options": {}
      },
      "id": "7c987595-70e1-43cc-aa70-68e78f3c6039",
      "name": "Confirm Reset",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        -7120,
        16
      ],
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    }
  ],
  "connections": {
    "Parse AD Events": {
      "main": [
        [
          {
            "node": "Check Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email HTML": {
      "main": [
        [
          {
            "node": "Send Unlcoked Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Keep all incoming items": {
      "main": [
        [
          {
            "node": "Any lockouts?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Memory": {
      "main": [
        [
          {
            "node": "Keep all incoming items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any lockouts?": {
      "main": [
        [
          {
            "node": "Build Email HTML",
            "type": "main",
            "index": 0
          },
          {
            "node": "Slack Buttons",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run AD Lockout Script": {
      "main": [
        [
          {
            "node": "Parse AD Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 1 min": {
      "main": [
        [
          {
            "node": "Run AD Lockout Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate All Items": {
      "main": [
        [
          {
            "node": "Build Email HTML1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Password Expiry Script": {
      "main": [
        [
          {
            "node": "Parse Password Expiry Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Password Expiry Data": {
      "main": [
        [
          {
            "node": "Check Memory1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any expired/expiring?": {
      "main": [
        [
          {
            "node": "Send Password Expiry Alert",
            "type": "main",
            "index": 0
          },
          {
            "node": "Build Slack Buttons",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Events1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Memory1": {
      "main": [
        [
          {
            "node": "Aggregate All Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email HTML1": {
      "main": [
        [
          {
            "node": "Any expired/expiring?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Unlock?": {
      "main": [
        [
          {
            "node": "Run Unlock Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Execute Reset": {
      "main": [
        [
          {
            "node": "Confirm Reset",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Unlock Script": {
      "main": [
        [
          {
            "node": "Confirm Unlock",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Click": {
      "main": [
        [
          {
            "node": "Is Unlock?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Is Reset?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Button Handler": {
      "main": [
        [
          {
            "node": "Parse Click",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Reset?": {
      "main": [
        [
          {
            "node": "Execute Reset",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Slack Buttons": {
      "main": [
        [
          {
            "node": "Send Slack Unlock Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Slack Buttons": {
      "main": [
        [
          {
            "node": "Send Password Expiry Alert Slack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 12 hours": {
      "main": [
        [
          {
            "node": "Run Password Expiry Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "Asia/Jerusalem",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Every 1 min": {
      "recurrenceRules": []
    },
    "node:Every 12 hours": {
      "recurrenceRules": []
    },
    "global": {
      "lastAlertTime": {
        "Steve": 1771077251533,
        "nalav": 1771077956193
      }
    },
    "node:Every 6 hours": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {
    "Slack Button Handler": [
      {
        "json": {
          "headers": {
            "host": "n8n.pi.alex-it.net",
            "x-forwarded-scheme": "https",
            "x-forwarded-proto": "https",
            "x-forwarded-for": "44.212.96.145",
            "x-real-ip": "44.212.96.145",
            "content-length": "7120",
            "user-agent": "Slackbot 1.0 (+https://api.slack.com/robots)",
            "accept-encoding": "gzip,deflate",
            "accept": "application/json,*/*",
            "x-slack-signature": "v0=cb743b54d03a83c89630c328a206fd3d98c0b676a2a2dca81fd58729e97c5c04",
            "x-slack-request-timestamp": "1771076948",
            "content-type": "application/x-www-form-urlencoded"
          },
          "params": {},
          "query": {},
          "body": {
            "payload": "{\"type\":\"block_actions\",\"user\":{\"id\":\"U08AYDL2FQD\",\"username\":\"vinokura\",\"name\":\"vinokura\",\"team_id\":\"T08BDV57FCZ\"},\"api_app_id\":\"A0AEQQ9AFD3\",\"token\":\"oRYdYVWIVs1aYFRWLpcwmajB\",\"container\":{\"type\":\"message\",\"message_ts\":\"1771076942.634559\",\"channel_id\":\"C0AE6LM59QF\",\"is_ephemeral\":false},\"trigger_id\":\"10508375509413.8387991253441.b4c68997faec6ee51da4ae5f579b4c3d\",\"team\":{\"id\":\"T08BDV57FCZ\",\"domain\":\"alex-it-hq\"},\"enterprise\":null,\"is_enterprise_install\":false,\"channel\":{\"id\":\"C0AE6LM59QF\",\"name\":\"privategroup\"},\"message\":{\"user\":\"U0AECPFUUHM\",\"type\":\"message\",\"ts\":\"1771076942.634559\",\"bot_id\":\"B0AES5DLPC6\",\"app_id\":\"A0AEQQ9AFD3\",\"text\":\":rotating_light: AD Lockout Alert\",\"team\":\"T08BDV57FCZ\",\"blocks\":[{\"type\":\"header\",\"block_id\":\"EqS4R\",\"text\":{\"type\":\"plain_text\",\"text\":\":rotating_light: AD ACCOUNT ALERT (Total: 4)\",\"emoji\":true}},{\"type\":\"divider\",\"block_id\":\"t0dZC\"},{\"type\":\"section\",\"block_id\":\"\\/y5Y4\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":bust_in_silhouette: *Full Name:* Alex itay\\n:id: *Username:* `alexi`\\n:computer: *Workstation:* `Unknown`\\n:date: *Timestamp:* undefined\",\"verbatim\":false}},{\"type\":\"divider\",\"block_id\":\"0wLBV\"},{\"type\":\"section\",\"block_id\":\"8HRiD\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":closed_lock_with_key: *Action:* Resetting will set a temp password and force a change at next login.\",\"verbatim\":false}},{\"type\":\"actions\",\"block_id\":\"6qT\\/U\",\"elements\":[{\"type\":\"button\",\"action_id\":\"btn_reset_password\",\"text\":{\"type\":\"plain_text\",\"text\":\"Reset Password\",\"emoji\":true},\"style\":\"danger\",\"value\":\"alexi\"}]},{\"type\":\"context\",\"block_id\":\"kVRMw\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":robot_face: Automated with AD Admin Bot\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"LmeP+\"},{\"type\":\"section\",\"block_id\":\"M6hYK\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":bust_in_silhouette: *Full Name:* itafa itay\\n:id: *Username:* `itafai`\\n:computer: *Workstation:* `Unknown`\\n:date: *Timestamp:* undefined\",\"verbatim\":false}},{\"type\":\"divider\",\"block_id\":\"RzYin\"},{\"type\":\"section\",\"block_id\":\"5yCzB\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":closed_lock_with_key: *Action:* Resetting will set a temp password and force a change at next login.\",\"verbatim\":false}},{\"type\":\"actions\",\"block_id\":\"p2SSJ\",\"elements\":[{\"type\":\"button\",\"action_id\":\"btn_reset_password\",\"text\":{\"type\":\"plain_text\",\"text\":\"Reset Password\",\"emoji\":true},\"style\":\"danger\",\"value\":\"itafai\"}]},{\"type\":\"context\",\"block_id\":\"zNRFc\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":robot_face: Automated with AD Admin Bot\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"9LG6j\"},{\"type\":\"section\",\"block_id\":\"7Nk6B\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":bust_in_silhouette: *Full Name:* Shlomi Vinokur\\n:id: *Username:* `shlomiv`\\n:computer: *Workstation:* `Unknown`\\n:date: *Timestamp:* undefined\",\"verbatim\":false}},{\"type\":\"divider\",\"block_id\":\"+JGqz\"},{\"type\":\"section\",\"block_id\":\"djmEw\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":closed_lock_with_key: *Action:* Resetting will set a temp password and force a change at next login.\",\"verbatim\":false}},{\"type\":\"actions\",\"block_id\":\"xrwnB\",\"elements\":[{\"type\":\"button\",\"action_id\":\"btn_reset_password\",\"text\":{\"type\":\"plain_text\",\"text\":\"Reset Password\",\"emoji\":true},\"style\":\"danger\",\"value\":\"shlomiv\"}]},{\"type\":\"context\",\"block_id\":\"JZXOq\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":robot_face: Automated with AD Admin Bot\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"D\\/yn6\"},{\"type\":\"section\",\"block_id\":\"FSvVZ\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":bust_in_silhouette: *Full Name:* Noa Vinokur\\n:id: *Username:* `noa`\\n:computer: *Workstation:* `Unknown`\\n:date: *Timestamp:* undefined\",\"verbatim\":false}},{\"type\":\"divider\",\"block_id\":\"oGh5I\"},{\"type\":\"section\",\"block_id\":\"HXD80\",\"text\":{\"type\":\"mrkdwn\",\"text\":\":closed_lock_with_key: *Action:* Resetting will set a temp password and force a change at next login.\",\"verbatim\":false}},{\"type\":\"actions\",\"block_id\":\"Mxr0Y\",\"elements\":[{\"type\":\"button\",\"action_id\":\"btn_reset_password\",\"text\":{\"type\":\"plain_text\",\"text\":\"Reset Password\",\"emoji\":true},\"style\":\"danger\",\"value\":\"noa\"}]},{\"type\":\"context\",\"block_id\":\"Xjzpz\",\"elements\":[{\"type\":\"mrkdwn\",\"text\":\":robot_face: Automated with AD Admin Bot\",\"verbatim\":false}]},{\"type\":\"divider\",\"block_id\":\"Po6zW\"}]},\"state\":{\"values\":{}},\"response_url\":\"https:\\/\\/hooks.slack.com\\/actions\\/T08BDV57FCZ\\/10515408240868\\/zlH2oSKNwfeisFv1cqcWRxqy\",\"actions\":[{\"action_id\":\"btn_reset_password\",\"block_id\":\"xrwnB\",\"text\":{\"type\":\"plain_text\",\"text\":\"Reset Password\",\"emoji\":true},\"value\":\"shlomiv\",\"style\":\"danger\",\"type\":\"button\",\"action_ts\":\"1771076948.279044\"}]}"
          },
          "webhookUrl": "https://n8n.pi.alex-it.net/webhook/slack/interactive",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "versionId": "5325c1be-191d-4b74-9130-9327166ff175",
  "activeVersionId": "5325c1be-191d-4b74-9130-9327166ff175",
  "triggerCount": 3,
  "shared": [
    {
      "updatedAt": "2026-02-14T13:06:15.241Z",
      "createdAt": "2026-02-14T13:06:15.241Z",
      "role": "workflow:owner",
      "workflowId": "0fhPT29ipmgj83wO",
      "projectId": "pWTWmuHnmIHw48U9"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-14T14:24:49.000Z",
    "createdAt": "2026-02-14T14:24:46.178Z",
    "versionId": "5325c1be-191d-4b74-9130-9327166ff175",
    "workflowId": "0fhPT29ipmgj83wO",
    "nodes": [
      {
        "parameters": {
          "jsCode": "// 1. Get the raw output from PowerShell\nlet raw = $input.first().json.stdout;\nlet events = [];\n\n// 2. Parse the JSON string\nif (raw && typeof raw === 'string' && raw.trim() !== '') {\n  try {\n    let parsed = JSON.parse(raw);\n    events = Array.isArray(parsed) ? parsed : [parsed];\n  } catch (e) {\n    return [];\n  }\n}\n\n// 3. Map the data and fix the timestamp format\nreturn events.map(e => {\n  const d = new Date(e.Timestamp);\n  \n  // Build \"13.2.2026\"\n  const day = d.getDate();\n  const month = d.getMonth() + 1; // Months are 0-11, so we add 1\n  const year = d.getFullYear();\n  \n  // Build \"11:58 AM\"\n  let hours = d.getHours();\n  const minutes = d.getMinutes().toString().padStart(2, '0');\n  const ampm = hours >= 12 ? 'PM' : 'AM';\n  hours = hours % 12;\n  hours = hours ? hours : 12; // the hour '0' should be '12'\n  \n  // Combine them: \"13.2.2026 11:58 AM\"\n  const friendlyTime = `${day}.${month}.${year} ${hours}:${minutes} ${ampm}`;\n\n  return {\n    json: {\n      username: e.Username,\n      fullname: e.FullName,\n      computer: e.CallerComputer || 'UNKNOWN',\n      timestamp: friendlyTime \n    }\n  };\n});"
        },
        "id": "68755909-a9f0-4163-8bab-3ef4711e9075",
        "name": "Parse AD Events",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -8000,
          -1264
        ]
      },
      {
        "parameters": {
          "jsCode": "// Build the table rows as a clean string\nconst lockouts = $json.data;\nconst tableRows = lockouts.map((item, idx) => {\n  const bgColor = idx % 2 === 0 ? '#ffffff' : '#f8f9fa';\n  return `\n    <tr style=\"border-bottom: 1px solid #e0e0e0; background-color: ${bgColor};\">\n      <td style=\"padding: 14px 16px; font-family: sans-serif; font-size: 13px;\">${item.username}</td>\n      <td style=\"padding: 14px 16px; font-weight: 500;\">${item.fullname || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px;\"><span style=\"background-color: #fadbd8; color: #c0392b; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px;\">‚ö† Locked</span></td>\n      <td style=\"padding: 14px 16px;\">${item.computer || '‚Äî'}</td>\n      <td style=\"padding: 14px 16px; color: #7f8c8d;\">${item.timestamp}</td>\n    </tr>`;\n}).join('');\n\nconst fullHtml = `\n<div style=\"font-family: sans-serif; color: #333; max-width: 900px;\">\n     <div style=\"background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 24px; border-radius: 8px 8px 0 0;\">\n         <h2 style=\"margin: 0;\">üîê AD Account Lockouts</h2>\n         <p style=\"margin: 8px 0 0 0; opacity: 0.9;\">Live Status Monitor</p>\n     </div>\n     <div style=\"background: white; border: 1px solid #e0e0e0; border-radius: 0 0 8px 8px; overflow: hidden;\">\n         <table style=\"border-collapse: collapse; width: 100%;\">\n             <thead>\n                 <tr style=\"background-color: #f8f9fa; border-bottom: 2px solid #e0e0e0;\">\n                     <th style=\"padding: 16px; text-align: left;\">Username</th>\n                     <th style=\"padding: 16px; text-align: left;\">Full Name</th>\n                     <th style=\"padding: 16px; text-align: left;\">Status</th>\n                     <th style=\"padding: 16px; text-align: left;\">Source</th>\n                     <th style=\"padding: 16px; text-align: left;\">Last Check</th>\n                 </tr>\n             </thead>\n             <tbody>${tableRows}</tbody>\n         </table>\n     </div>\n     <div style=\"background: #f8f9fa; padding: 16px; text-align: right; font-size: 12px; color: #95a5a6;\">\n         <em>Generated via n8n</em>\n     </div>\n</div>`;\n\nreturn { \n  emailHtml: fullHtml,\n  lockoutCount: lockouts.length\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7120,
          -1824
        ],
        "id": "391e9836-d320-4c89-b91f-0414239ac75d",
        "name": "Build Email HTML"
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -7504,
          -1264
        ],
        "id": "54391d1c-e8da-421f-a7ba-2391780ec54b",
        "name": "Keep all incoming items"
      },
      {
        "parameters": {
          "jsCode": "const currentLockouts = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertTime = staticData.lastAlertTime || {};\n\nconst now = Date.now();\nconst FOUR_HOURS = 4 * 60 * 60 * 1000;\n\nconst newLockouts = currentLockouts.filter(item => {\n  const user = item.json.username;\n  const lastAlert = staticData.lastAlertTime[user];\n  \n  if (!lastAlert || (now - lastAlert) > FOUR_HOURS) {\n    staticData.lastAlertTime[user] = now;\n    return true;\n  }\n  return false;\n});\n\nreturn newLockouts;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7776,
          -1264
        ],
        "id": "814d196a-809a-47a8-a538-55cedd37660d",
        "name": "Check Memory"
      },
      {
        "parameters": {},
        "id": "a631ab5a-a2d3-477c-97ca-3bd202e3fdbf",
        "name": "No Events",
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -6752,
          -1248
        ]
      },
      {
        "parameters": {
          "conditions": {
            "number": [
              {
                "value1": "={{ $json.data.length }}",
                "operation": "larger"
              }
            ]
          }
        },
        "id": "a3d39e64-ea4e-4fd3-8c9c-656117e038b2",
        "name": "Any lockouts?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          -7232,
          -1264
        ]
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Lockout-Monitor.ps1\"",
          "cwd": "="
        },
        "id": "2a4764c1-0ef9-4bba-b865-86ac7145cd4c",
        "name": "Run AD Lockout Script",
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          -8224,
          -1264
        ],
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        }
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "minutes",
                "minutesInterval": 1
              }
            ]
          }
        },
        "id": "b3a8012f-a2e8-422e-94d1-83e0676d59fb",
        "name": "Every 1 min",
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1,
        "position": [
          -8544,
          -1264
        ]
      },
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -7424,
          -656
        ],
        "id": "ed6cd258-63f4-4246-ab7a-0a71bd59ea75",
        "name": "Aggregate All Items"
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Password-Expiry.ps1\"",
          "cwd": "="
        },
        "id": "d2d6a810-c6b6-45e5-8bea-32b4c1241ff1",
        "name": "Run Password Expiry Script",
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          -8224,
          -656
        ],
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Debug: Log raw output\nconst rawStdout = $input.first().json.stdout;\nconsole.log('Raw stdout:', rawStdout);\nconsole.log('Stdout type:', typeof rawStdout);\nconsole.log('Stdout length:', rawStdout ? rawStdout.length : 0);\n\n// Check if we have any output\nif (!rawStdout || rawStdout.trim() === '') {\n  console.error('No output from PowerShell script');\n  return { json: { data: [], error: 'No output from script', debug: 'Empty stdout' } };\n}\n\nlet parsedData = null;\n\ntry {\n  // Try to parse as JSON\n  parsedData = JSON.parse(rawStdout);\n  console.log('Successfully parsed JSON:', parsedData);\n} catch (parseError) {\n  console.error('JSON parse failed:', parseError.message);\n  console.error('Attempted to parse:', rawStdout.substring(0, 500));\n  \n  // Try to extract JSON from mixed output\n  const jsonMatch = rawStdout.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsedData = JSON.parse(jsonMatch[0]);\n      console.log('Extracted JSON from mixed output');\n    } catch (e) {\n      console.error('Failed to extract JSON:', e.message);\n      return { json: { data: [], error: 'Failed to parse JSON', raw: rawStdout.substring(0, 200) } };\n    }\n  } else {\n    return { json: { data: [], error: 'No JSON found in output', raw: rawStdout.substring(0, 200) } };\n  }\n}\n\n// Extract data array\nconst data = parsedData.Data || parsedData.data || [];\nconsole.log('Extracted data array, count:', data.length);\n\nif (!Array.isArray(data)) {\n  console.error('Data is not an array:', typeof data);\n  return { json: { data: [], error: 'Data is not an array' } };\n}\n\n// Return properly formatted items\nconst result = data.map((user, index) => {\n  console.log(`Processing user ${index}:`, user);\n  \n  return {\n    json: {\n      username: user.Username || user.username || '',\n      fullname: user.FullName || user.fullname || user.FullName || '',\n      email: user.Email || user.email || '',\n      expiryDate: user.ExpiryDate || user.expiryDate || '',\n      daysUntilExpiry: parseInt(user.DaysUntilExpiry || user.daysUntilExpiry || 0),\n      lastPasswordChange: user.LastPasswordChange || user.lastPasswordChange || '',\n      passwordNeverExpires: user.PasswordNeverExpires || user.passwordNeverExpires || false\n    }\n  };\n});\n\nconsole.log('Parsed result count:', result.length);\nif (result.length > 0) {\n  console.log('First result:', result[0]);\n}\n\nreturn result;"
        },
        "id": "718614b8-401f-4a60-9711-2f5056fa6b63",
        "name": "Parse Password Expiry Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7936,
          -656
        ]
      },
      {
        "parameters": {
          "conditions": {
            "number": [
              {
                "value1": "={{ Object.keys($json).length > 0 ? 1 : 0 }}",
                "operation": "larger"
              }
            ]
          }
        },
        "id": "3b4d9ecd-c7de-4f93-8a70-bce1b1b19e32",
        "name": "Any expired/expiring?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          -6864,
          -656
        ]
      },
      {
        "parameters": {
          "jsCode": "const currentUsers = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertedDate = staticData.lastAlertedDate || {};\n\nconst today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\nreturn currentUsers.filter(item => {\n  const user = item.json.username;\n  const lastDate = staticData.lastAlertedDate[user];\n\n  // Only alert once per day\n  if (lastDate !== today) {\n    staticData.lastAlertedDate[user] = today;\n    return true;\n  }\n  return false;\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7664,
          -656
        ],
        "id": "1cbe159a-33c6-4c49-b84d-db30876d4bf2",
        "name": "Check Memory1"
      },
      {
        "parameters": {},
        "id": "f8a52b72-891f-4efe-8d3d-1b50ec83d526",
        "name": "No Events1",
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          -6560,
          -480
        ]
      },
      {
        "parameters": {
          "jsCode": "// Safely extract and aggregate data\nconst allItems = $input.all();\nconsole.log('Input items:', allItems.length);\n\nif (!allItems || allItems.length === 0) {\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Get the aggregated data\nconst firstItem = allItems[0].json;\nconsole.log('First item structure:', Object.keys(firstItem));\n\n// If data is already aggregated in json.data array\nlet usersData = [];\nif (firstItem.data && Array.isArray(firstItem.data)) {\n  usersData = firstItem.data;\n  console.log('Got users from data array:', usersData.length);\n} else if (firstItem.username) {\n  // Individual user items\n  usersData = allItems.map(item => item.json);\n  console.log('Got users from individual items:', usersData.length);\n}\n\nif (!usersData || usersData.length === 0) {\n  console.error('No user data found');\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Build HTML table\nconst tableRows = usersData.map(user => {\n  const daysLeft = parseInt(user.daysUntilExpiry || user.DaysUntilExpiry || 0);\n  const statusColor = daysLeft <= 0 ? '#e74c3c' : (daysLeft <= 3 ? '#e67e22' : (daysLeft <= 7 ? '#f39c12' : '#27ae60'));\n  const statusText = daysLeft <= 0 ? 'EXPIRED' : `${daysLeft} Days`;\n  const username = user.username || user.Username || '';\n  const fullname = user.fullname || user.FullName || '';\n  const email = user.email || user.Email || 'N/A';\n  const expiryDate = user.expiryDate || user.ExpiryDate || 'N/A';\n  \n  console.log(`Building row for ${username}: ${daysLeft} days`);\n  \n  return `\n    <tr style=\"border-bottom: 1px solid #eee;\">\n      <td style=\"padding: 12px; font-weight: 500;\">${username}</td>\n      <td style=\"padding: 12px;\">${fullname}</td>\n      <td style=\"padding: 12px;\">${email}</td>\n      <td style=\"padding: 12px; color: white; font-weight: bold; background-color: ${statusColor}; border-radius: 4px; text-align: center;\">\n        ${statusText}\n      </td>\n      <td style=\"padding: 12px;\">${expiryDate}</td>\n    </tr>`;\n}).join('');\n\nconst expiringCount = usersData.length;\nconst criticalCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 3).length;\nconst expiredCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 0).length;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .header { background-color: #2c3e50; color: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .header p { margin: 5px 0 0 0; opacity: 0.9; }\n    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n    .summary-card { background: white; padding: 15px; border-radius: 4px; border-left: 4px solid #3498db; }\n    .summary-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }\n    .summary-card .number { font-size: 32px; font-weight: bold; color: #2c3e50; }\n    .table-container { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .table-container h2 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }\n    table { width: 100%; border-collapse: collapse; }\n    th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-weight: bold; font-size: 14px; }\n    td { padding: 12px; }\n    .footer { text-align: center; color: #999; font-size: 12px; padding: 20px 0; border-top: 1px solid #eee; }\n    .warning { background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107; }\n    .warning strong { color: #856404; }\n    .warning ul { margin: 10px 0 0 0; padding-left: 20px; }\n    .warning li { margin: 5px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üîê Password Expiry Alert Report</h1>\n      <p>Generated: ${new Date().toLocaleString()}</p>\n    </div>\n    \n    <div class=\"summary\">\n      <div class=\"summary-card\">\n        <h3>Total Expiring</h3>\n        <div class=\"number\">${expiringCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #e74c3c;\">\n        <h3>Critical (‚â§3 days)</h3>\n        <div class=\"number\" style=\"color: #e74c3c;\">${criticalCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #c0392b;\">\n        <h3>Already Expired</h3>\n        <div class=\"number\" style=\"color: #c0392b;\">${expiredCount}</div>\n      </div>\n    </div>\n    \n    <div class=\"table-container\">\n      <h2>User Password Status</h2>\n      <table>\n        <thead>\n          <tr>\n            <th>Username</th>\n            <th>Full Name</th>\n            <th>Email</th>\n            <th>Status</th>\n            <th>Expiry Date</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${tableRows}\n        </tbody>\n      </table>\n    </div>\n    \n    <div class=\"warning\">\n      <strong>‚ö†Ô∏è Action Required:</strong>\n      <ul>\n        <li>Users with expiring passwords should reset them immediately</li>\n        <li>Expired passwords may result in account lockouts or login failures</li>\n        <li>Contact IT if unable to change password via self-service portal</li>\n        <li>IT Team: Verify script is running and users are receiving notifications</li>\n      </ul>\n    </div>\n    \n    <div class=\"footer\">\n      <p>This is an automated alert from Active Directory monitoring system.</p>\n      <p style=\"font-size: 11px; margin-top: 10px;\">If you believe this is in error, contact your IT department immediately.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nconsole.log('Built HTML email, user count:', expiringCount);\n\nreturn { json: { emailHtml: html, expiringCount: expiringCount, data: usersData } };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -7168,
          -656
        ],
        "id": "17513f60-bd0d-4e67-9e5d-f4b3664cd329",
        "name": "Build Email HTML1"
      },
      {
        "parameters": {
          "conditions": {
            "string": [
              {
                "value1": "={{ $json.action_id }}",
                "value2": "btn_unlock"
              }
            ]
          }
        },
        "id": "a9c44825-bfdb-45a2-b870-a9114a9888ec",
        "name": "Is Unlock?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          -7664,
          -304
        ]
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -Command \"$Username='{{ $json.username }}'; $NewPass='Temp' + (Get-Random -Minimum 1000 -Maximum 9999) + '!'; Set-ADAccountPassword -Identity $Username -NewPassword (ConvertTo-SecureString $NewPass -AsPlainText -Force) -Reset; Set-ADUser -Identity $Username -ChangePasswordAtLogon $true; Write-Output \\\"SUCCESS: Password for $Username reset to $NewPass\\\"\"",
          "cwd": "="
        },
        "id": "68497a96-583a-4729-8fa8-f2b71f0e5ab7",
        "name": "Execute Reset",
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          -7392,
          16
        ],
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        }
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/Unlock-ADAccount-n8n.ps1\" -Username \"{{ $json.username }}\"",
          "cwd": "="
        },
        "id": "a7a95b1d-640d-495b-bb22-a97ca24d2b60",
        "name": "Run Unlock Script",
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          -7344,
          -320
        ],
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const payload = JSON.parse($input.first().json.body.payload);\nreturn {\n  action_id: payload.actions[0].action_id,\n  username: payload.actions[0].value,\n  adminUser: payload.user.name\n};"
        },
        "id": "28e7365e-5250-4329-bc04-8eac1c5feaaf",
        "name": "Parse Click",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -8112,
          -160
        ]
      },
      {
        "parameters": {
          "httpMethod": "POST",
          "path": "slack/interactive",
          "options": {}
        },
        "id": "193cd7c6-3e57-4bb7-81bf-c34dd0115e69",
        "name": "Slack Button Handler",
        "type": "n8n-nodes-base.webhook",
        "typeVersion": 1,
        "position": [
          -8576,
          -160
        ],
        "webhookId": "95df20d8-f2b4-48f5-adab-5f3e0675d0ce"
      },
      {
        "parameters": {
          "conditions": {
            "string": [
              {
                "value1": "={{ $json.action_id }}",
                "value2": "btn_reset_password"
              }
            ]
          }
        },
        "id": "f8d18adc-d722-44ab-b0a0-51239214f6e4",
        "name": "Is Reset?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          -7680,
          32
        ]
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "={{ \"üö® URGENT: \" + $json.lockoutCount + \" Account(s) Locked Out\" }}",
          "message": "={{ $json.emailHtml }}",
          "options": {}
        },
        "id": "5e3d6ab7-4cc9-493e-bf53-b52cfb4a0a9e",
        "name": "Send Unlcoked Email",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2,
        "position": [
          -6752,
          -1824
        ],
        "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "slackApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "channel",
                "value": "C0AEJQD4FA6"
              },
              {
                "name": "text",
                "value": "üö® AD Lockout Alert"
              },
              {
                "name": "blocks",
                "value": "={{ $json.blocks }}"
              }
            ]
          },
          "options": {}
        },
        "id": "09d668bb-c68a-42bf-91df-3c64852868f3",
        "name": "Send Slack Unlock Message",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 3,
        "position": [
          -6512,
          -1472
        ],
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "={{ \"üîê ALERT: \" + $json.expiringCount + \" Password(s) Expiry Alert!\" }}",
          "message": "={{ $json.emailHtml }}",
          "options": {}
        },
        "id": "0f79f4c4-92b9-4cd3-b710-5f457c757762",
        "name": "Send Password Expiry Alert",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2,
        "position": [
          -6752,
          -1056
        ],
        "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "slackApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "channel",
                "value": "C0AE6LM59QF"
              },
              {
                "name": "text",
                "value": "üö® AD Lockout Alert"
              },
              {
                "name": "blocks",
                "value": "={{ $json.blocks }}"
              }
            ]
          },
          "options": {}
        },
        "id": "ce03e361-2e00-4838-9db3-d0b57177c84d",
        "name": "Send Password Expiry Alert Slack",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 3,
        "position": [
          -6272,
          -672
        ],
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "const inputItems = $input.first().json;\nconst lockouts = inputItems.data ? inputItems.data : $input.all().map(i => i.json);\n\nconst blocks = [];\n\n// 1. HEADER\nblocks.push({\n  \"type\": \"header\",\n  \"text\": {\n    \"type\": \"plain_text\",\n    \"text\": `üö® AD LOCKOUT DETECTED (Total: ${lockouts.length})`,\n    \"emoji\": true\n  }\n});\n\n// 2. DIVIDER\nblocks.push({ \"type\": \"divider\" });\n\n// 3. LOOP THROUGH USERS\nlockouts.forEach((user) => {\n  \n  // Format Date\n  let timeStr = user.timestamp;\n  const d = new Date(user.timestamp);\n  if (!isNaN(d)) {\n    const datePart = `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;\n    let hours = d.getHours();\n    const minutes = d.getMinutes().toString().padStart(2, '0');\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; \n    timeStr = `${datePart} ${hours}:${minutes} ${ampm}`;\n  }\n\n  // 4. USER DETAILS\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `üë§ *Full Name:* ${user.fullname || 'Unknown'}\\nüÜî *Username:* \\`${user.username}\\`\\nüíª *Workstation:* \\`${user.computer || 'Unknown'}\\`\\nüìÖ *Timestamp:* ${timeStr}`\n    }\n  });\n\n  // 5. DIVIDER\n  blocks.push({ \"type\": \"divider\" });\n\n  // 6. ACTION TEXT (Now on ONE line)\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"üîì *Action:* Please investigate and unlock these accounts if required.\"\n    }\n  });\n\n  // 7. BUTTON (Sits below the text)\n  blocks.push({\n    \"type\": \"actions\",\n    \"elements\": [\n      {\n        \"type\": \"button\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"Unlock Account\",\n          \"emoji\": true\n        },\n        \"style\": \"primary\", // Green Button\n        \"action_id\": \"btn_unlock\",\n        \"value\": user.username\n      }\n    ]\n  });\n\n  // 8. FOOTER\n  blocks.push({\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ü§ñ Automated with this n8n workflow\"\n      }\n    ]\n  });\n\n  // Space between multiple users\n  if (lockouts.length > 1) {\n     blocks.push({ \"type\": \"divider\" });\n  }\n});\n\nreturn { blocks };"
        },
        "id": "8c193273-9972-48fd-bbb8-890de9ab7aaa",
        "name": "Slack Buttons",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -6768,
          -1472
        ]
      },
      {
        "parameters": {
          "jsCode": "const inputItems = $input.first().json;\nconst lockouts = inputItems.data ? inputItems.data : $input.all().map(i => i.json);\n\nconst blocks = [];\n\n// 1. HEADER\nblocks.push({\n  \"type\": \"header\",\n  \"text\": {\n    \"type\": \"plain_text\",\n    \"text\": `üö® AD ACCOUNT ALERT (Total: ${lockouts.length})`,\n    \"emoji\": true\n  }\n});\n\n// 2. DIVIDER\nblocks.push({ \"type\": \"divider\" });\n\n// 3. LOOP THROUGH USERS\nlockouts.forEach((user) => {\n  \n  // Format Date\n  let timeStr = user.timestamp;\n  const d = new Date(user.timestamp);\n  if (!isNaN(d)) {\n    const datePart = `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;\n    let hours = d.getHours();\n    const minutes = d.getMinutes().toString().padStart(2, '0');\n    const ampm = hours >= 12 ? 'PM' : 'AM';\n    hours = hours % 12;\n    hours = hours ? hours : 12; \n    timeStr = `${datePart} ${hours}:${minutes} ${ampm}`;\n  }\n\n  // 4. USER DETAILS\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": `üë§ *Full Name:* ${user.fullname || 'Unknown'}\\nüÜî *Username:* \\`${user.username}\\`\\nüíª *Workstation:* \\`${user.computer || 'Unknown'}\\`\\nüìÖ *Timestamp:* ${timeStr}`\n    }\n  });\n\n  // 5. DIVIDER\n  blocks.push({ \"type\": \"divider\" });\n\n  // 6. ACTION TEXT (Updated for Reset)\n  blocks.push({\n    \"type\": \"section\",\n    \"text\": {\n      \"type\": \"mrkdwn\",\n      \"text\": \"üîê *Action:* Resetting will set a temp password and force a change at next login.\"\n    }\n  });\n\n  // 7. BUTTON (Updated to Reset Password)\n  blocks.push({\n    \"type\": \"actions\",\n    \"elements\": [\n      {\n        \"type\": \"button\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"Reset Password\",\n          \"emoji\": true\n        },\n        \"style\": \"danger\", // Red Button for a more sensitive action\n        \"action_id\": \"btn_reset_password\", // Matches the IF node logic\n        \"value\": user.username\n      }\n    ]\n  });\n\n  // 8. FOOTER\n  blocks.push({\n    \"type\": \"context\",\n    \"elements\": [\n      {\n        \"type\": \"mrkdwn\",\n        \"text\": \"ü§ñ Automated with AD Admin Bot\"\n      }\n    ]\n  });\n\n  // Space between multiple users\n  if (lockouts.length > 1) {\n     blocks.push({ \"type\": \"divider\" });\n  }\n});\n\nreturn { blocks };"
        },
        "id": "752fc1b3-bd26-4b8c-8476-0d3f788e78dd",
        "name": "Build Slack Buttons",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -6544,
          -672
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "slackApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "channel",
                "value": "C0AEJQD4FA6"
              },
              {
                "name": "attachments",
                "value": "=[\n  {\n    \"color\": \"#36a64f\",\n    \"blocks\": [\n      {\n        \"type\": \"header\",\n        \"text\": {\n          \"type\": \"plain_text\",\n          \"text\": \"‚úÖ Success: Account Unlocked!\",\n          \"emoji\": true\n        }\n      },\n      {\n        \"type\": \"section\",\n        \"text\": {\n          \"type\": \"mrkdwn\",\n          \"text\": \"The account has been Unlocked!\\n\\nüë§ *Account:* `{{ $node[\"Parse Click\"].json.username }}`\\nüõ°Ô∏è *Admin:* `{{ $node[\"Parse Click\"].json.adminUser }}`\"\n        }\n      },\n      {\n        \"type\": \"context\",\n        \"elements\": [\n          {\n            \"type\": \"plain_text\",\n            \"text\": \"Action logged via AD Admin Bot\",\n            \"emoji\": true\n          }\n        ]\n      }\n    ]\n  }\n]"
              }
            ]
          },
          "options": {}
        },
        "id": "b3ab4ffa-39f2-4de3-8068-460a8ccded37",
        "name": "Confirm Unlock",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 3,
        "position": [
          -7120,
          -320
        ],
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "hours",
                "hoursInterval": 12
              }
            ]
          }
        },
        "id": "34d09486-add7-4879-9370-88422bcf893a",
        "name": "Every 12 hours",
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1,
        "position": [
          -8624,
          -656
        ]
      },
      {
        "parameters": {
          "method": "POST",
          "url": "https://slack.com/api/chat.postMessage",
          "authentication": "predefinedCredentialType",
          "nodeCredentialType": "slackApi",
          "sendBody": true,
          "bodyParameters": {
            "parameters": [
              {
                "name": "channel",
                "value": "C0AE6LM59QF"
              },
              {
                "name": "text",
                "value": "={{ \n  \"üîê *Password Reset Success*\\n\\n\" + \n  \"üë§ *Account:* `\" + $node[\"Execute Reset\"].json.username + \"`\\n\" +\n  \"üîë *New Temp Password:* `\" + $node[\"Execute Reset\"].json.stdout.split('to ')[1] + \"`\\n\" +\n  \"üõ°Ô∏è *Admin:* `\" + $node[\"Parse Click1\"].json.adminUser + \"`\\n\\n\" +\n  \"‚ö†Ô∏è _User is forced to change password at next login._\"\n}}"
              }
            ]
          },
          "options": {}
        },
        "id": "7c987595-70e1-43cc-aa70-68e78f3c6039",
        "name": "Confirm Reset",
        "type": "n8n-nodes-base.httpRequest",
        "typeVersion": 3,
        "position": [
          -7120,
          16
        ],
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      }
    ],
    "connections": {
      "Parse AD Events": {
        "main": [
          [
            {
              "node": "Check Memory",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Email HTML": {
        "main": [
          [
            {
              "node": "Send Unlcoked Email",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Keep all incoming items": {
        "main": [
          [
            {
              "node": "Any lockouts?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Memory": {
        "main": [
          [
            {
              "node": "Keep all incoming items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Any lockouts?": {
        "main": [
          [
            {
              "node": "Build Email HTML",
              "type": "main",
              "index": 0
            },
            {
              "node": "Slack Buttons",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Events",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run AD Lockout Script": {
        "main": [
          [
            {
              "node": "Parse AD Events",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Every 1 min": {
        "main": [
          [
            {
              "node": "Run AD Lockout Script",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Aggregate All Items": {
        "main": [
          [
            {
              "node": "Build Email HTML1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run Password Expiry Script": {
        "main": [
          [
            {
              "node": "Parse Password Expiry Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Password Expiry Data": {
        "main": [
          [
            {
              "node": "Check Memory1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Any expired/expiring?": {
        "main": [
          [
            {
              "node": "Send Password Expiry Alert",
              "type": "main",
              "index": 0
            },
            {
              "node": "Build Slack Buttons",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Events1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Memory1": {
        "main": [
          [
            {
              "node": "Aggregate All Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Email HTML1": {
        "main": [
          [
            {
              "node": "Any expired/expiring?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Unlock?": {
        "main": [
          [
            {
              "node": "Run Unlock Script",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Execute Reset": {
        "main": [
          [
            {
              "node": "Confirm Reset",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run Unlock Script": {
        "main": [
          [
            {
              "node": "Confirm Unlock",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Click": {
        "main": [
          [
            {
              "node": "Is Unlock?",
              "type": "main",
              "index": 0
            },
            {
              "node": "Is Reset?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Slack Button Handler": {
        "main": [
          [
            {
              "node": "Parse Click",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Is Reset?": {
        "main": [
          [
            {
              "node": "Execute Reset",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Slack Buttons": {
        "main": [
          [
            {
              "node": "Send Slack Unlock Message",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Slack Buttons": {
        "main": [
          [
            {
              "node": "Send Password Expiry Alert Slack",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Every 12 hours": {
        "main": [
          [
            {
              "node": "Run Password Expiry Script",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Alex Vinokur",
    "name": "Version 5325c1be",
    "description": "",
    "autosaved": true
  },
  "tags": []
}