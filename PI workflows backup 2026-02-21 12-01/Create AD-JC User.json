{
  "updatedAt": "2026-02-21T06:29:32.544Z",
  "createdAt": "2025-09-02T14:13:13.473Z",
  "id": "vb6sSMl5XrlcvUae",
  "name": "Create AD/JC User",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\Scripts\\Create-ADUser-From-n8n.ps1\" -FirstName \"{{$json[\"body\"][\"firstname\"]}}\" -LastName \"{{$json[\"body\"][\"lastname\"]}}\" -EmployeeNumber {{$json[\"body\"][\"employeenumber\"]}} -JobTitle \"{{$json[\"body\"][\"jobtitle\"]}}\" -Department \"{{$json[\"body\"][\"department\"]}}\" -ManagerSam \"{{$json[\"body\"][\"managersam\"]}}\" -OfficePhone \"{{$json[\"body\"][\"officephone\"]}}\" -OfficeLocation \"{{$json[\"body\"][\"officelocation\"]}}\" -SourceUsername \"{{$json[\"body\"][\"sourceusername\"]}}\"",
        "cwd": "="
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        368,
        416
      ],
      "id": "16e30789-dbad-4eb5-a9c3-3b5a50bebde4",
      "name": "Create New AD User",
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "sendTo": "={{ $('Gmail Trigger').item.json.from?.value?.map(v => v.address).join(', ') }}",
        "subject": "=Re: {{$('Gmail Trigger').item.json.subject}} - Processing Started",
        "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        0,
        -32
      ],
      "id": "e071b0fb-64e2-4f21-889f-f4a9a2a47d6e",
      "name": "Send Acknowledgment AD",
      "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ----- 1) Get the email body from this payload shape -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  // Normalize line breaks before stripping tags\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  // Strip tags\n  const text = html.replace(/<[^>]+>/g, ' ');\n  // Collapse whitespace\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\n// If body still empty, try base64-encoded Gmail payload (rare here but safe)\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\n// Safety: normalize whitespace for robust regex capture\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture (works for single-line or multiline) -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  // Accept either single-line or multiline values\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\nconst userData = {\n  firstname:      captureAfter('First Name', flat),\n  lastname:       captureAfter('Last Name', flat),\n  employeenumber: captureAfter('Employee Number', flat),\n  jobtitle:       captureAfter('Job Title', flat),\n  department:     captureAfter('Department', flat),\n  managersam:     captureAfter('Manager SAM', flat) || captureAfter('Manager', flat),\n  officephone:    captureAfter('Office Phone', flat) || captureAfter('Phone', flat),\n  officelocation: captureAfter('Office Location', flat) || captureAfter('Location', flat),\n  sourceusername: captureAfter('Source Username', flat),\n};\n\n// ----- 3) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match exactly.`);\n}\n\n// ----- 4) Subject/From/MessageId from this payload shape -----\nconst subj =\n  $json.subject ||\n  ($json.headers && typeof $json.headers.subject === 'string'\n    ? $json.headers.subject.replace(/^Subject:\\s*/i,'').trim()\n    : '');\n\nconst fromText =\n  ($json.from && $json.from.text) ||\n  ($json.headers && typeof $json.headers.from === 'string'\n    ? $json.headers.from.replace(/^From:\\s*/i,'').trim()\n    : '');\n\nconst msgId =\n  $json.messageId ||\n  ($json.headers && typeof $json.headers['message-id'] === 'string'\n    ? $json.headers['message-id'].replace(/^Message-Id:\\s*/i,'').trim()\n    : '');\n\n// ----- 5) Return in your expected shape -----\nreturn {\n  body: userData,\n  originalEmail: {\n    subject: subj,\n    from: fromText,\n    messageId: msgId,\n  },\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -112,
        416
      ],
      "id": "420d63d7-c0a9-4910-aa90-31f9d11472f2",
      "name": "Email Parser AD",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"PowerShell script error: \" + out.error);\n}\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        784,
        416
      ],
      "id": "a76c1c8f-bc80-41d2-bc27-1df8b0c21a61",
      "name": "PowerShell Output Parser AD",
      "disabled": true
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C099QKJSCTD",
          "mode": "list",
          "cachedResultName": "new-user-created"
        },
        "text": "=ü§ñ *New JC User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüÜî *Username:* `{{$json[\"Username\"]}}`\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        1056,
        -64
      ],
      "id": "258060f6-6700-4e0b-bcaa-052d3d3e4d33",
      "name": "Send a message JC",
      "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "New AD user Created",
        "message": "=<h1 style=\"color:blue;\">ü§ñ New AD User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1072,
        192
      ],
      "id": "1fecd824-667e-4228-8e53-920d098200ec",
      "name": "Send Message AD",
      "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=ü§ñ *New AD User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n*DL Groups Copied:* {{$json[\"DLGroupsCopied\"].join(', ')}}\n*Security Groups Copied:* {{$json[\"SecurityGroupsCopied\"].join(', ')}}\n{{$json[\"ConflictMessage\"]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1072,
        416
      ],
      "id": "b16cae5c-90fd-4b74-8395-3794884929eb",
      "name": "Send a text message AD",
      "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C099QKJSCTD",
          "mode": "list",
          "cachedResultName": "new-user-created"
        },
        "text": "=ü§ñ *New AD User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n‚úâÔ∏è *DL Groups:* {{ $json[\"DLGroupsCopied\"].length > 0 ? $json[\"DLGroupsCopied\"].join(', ') : '_None_' }}\nüõ°Ô∏è *Security Groups:* {{ $json[\"SecurityGroupsCopied\"].length > 0 ? $json[\"SecurityGroupsCopied\"].join(', ') : '_None_' }}\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        1088,
        624
      ],
      "id": "98d17c73-ea6c-4117-b6a1-49b4deddfb51",
      "name": "Send a message AD",
      "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -Command \"& { C:\\Scripts\\Create-JCUser-From-n8n.ps1 -FirstName '{{$json[\"body\"][\"firstname\"]}}' -LastName '{{$json[\"body\"][\"lastname\"]}}' -EmployeeNumber '{{$json[\"body\"][\"employeenumber\"]}}' -JobTitle '{{$json[\"body\"][\"jobtitle\"]}}' -Department '{{$json[\"body\"][\"department\"]}}' -ManagerSam '{{$json[\"body\"][\"managersam\"]}}' -OfficePhone '{{$json[\"body\"][\"officephone\"]}}' -OfficeLocation '{{$json[\"body\"][\"officelocation\"]}}' }\"",
        "cwd": "="
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        352,
        -272
      ],
      "id": "97f98a71-7f8f-46e2-9f29-ed666099cfd8",
      "name": "Create New JC User",
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7dd6a3f5-aa13-4fdc-88f8-a9798fbf925d",
                    "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                    "rightValue": "JC",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3367d402-3127-4cf0-b3de-69d8cdc8cf90",
                    "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                    "rightValue": "AD",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -512,
        -256
      ],
      "id": "993a8e12-82d3-4d63-883a-9db0a1044125",
      "name": "Switch",
      "disabled": true
    },
    {
      "parameters": {
        "sendTo": "={{ $('Gmail Trigger').item.json.from?.value?.map(v => v.address).join(', ') }}",
        "subject": "=Re: {{$('Gmail Trigger').item.json.subject}} - Processing Started",
        "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        16,
        -640
      ],
      "id": "929d2895-9391-42c2-ad5b-5fa164d06798",
      "name": "Send Acknowledgment JC",
      "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {},
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        -848,
        -256
      ],
      "id": "287481f1-9fd6-4e50-8a59-b2483c508a50",
      "name": "Gmail Trigger",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ----- 1) Get the email body from this payload shape -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  // Normalize line breaks before stripping tags\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  // Strip tags\n  const text = html.replace(/<[^>]+>/g, ' ');\n  // Collapse whitespace\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\n// If body still empty, try base64-encoded Gmail payload (rare here but safe)\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\n// Safety: normalize whitespace for robust regex capture\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture (works for single-line or multiline) -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  // Accept either single-line or multiline values\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\nconst userData = {\n  firstname:      captureAfter('First Name', flat),\n  lastname:       captureAfter('Last Name', flat),\n  employeenumber: captureAfter('Employee Number', flat),\n  jobtitle:       captureAfter('Job Title', flat),\n  department:     captureAfter('Department', flat),\n  managersam:     captureAfter('Manager SAM', flat) || captureAfter('Manager', flat),\n  officephone:    captureAfter('Office Phone', flat) || captureAfter('Phone', flat),\n  officelocation: captureAfter('Office Location', flat) || captureAfter('Location', flat),\n};\n\n// ----- 3) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match exactly.`);\n}\n\n// ----- 4) Subject/From/MessageId from this payload shape -----\nconst subj =\n  $json.subject ||\n  ($json.headers && typeof $json.headers.subject === 'string'\n    ? $json.headers.subject.replace(/^Subject:\\s*/i,'').trim()\n    : '');\n\nconst fromText =\n  ($json.from && $json.from.text) ||\n  ($json.headers && typeof $json.headers.from === 'string'\n    ? $json.headers.from.replace(/^From:\\s*/i,'').trim()\n    : '');\n\nconst msgId =\n  $json.messageId ||\n  ($json.headers && typeof $json.headers['message-id'] === 'string'\n    ? $json.headers['message-id'].replace(/^Message-Id:\\s*/i,'').trim()\n    : '');\n\n// ----- 5) Return in your expected shape -----\nreturn {\n  body: userData,\n  originalEmail: {\n    subject: subj,\n    from: fromText,\n    messageId: msgId,\n  },\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -96,
        -272
      ],
      "id": "a650085a-e0d0-4205-9033-105259013c20",
      "name": "Email Parser JC",
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"PowerShell script error: \" + out.error);\n}\nreturn out;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        -272
      ],
      "id": "a0e4d860-4076-4865-b5f5-a5c95b5ace91",
      "name": "PowerShell Output Parser JC",
      "disabled": true
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "New AD user Created",
        "message": "=<h1 style=\"color:blue;\">ü§ñ New JC User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1040,
        -544
      ],
      "id": "9c12337d-cfbd-42bb-bcda-8f0b61dfa8af",
      "name": "Send Message JC",
      "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=ü§ñ *New JC User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Username:* {{$json[\"Username\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n{{$json[\"ConflictMessage\"]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1056,
        -288
      ],
      "id": "62c0c511-99ec-449b-a85e-931f64cd7636",
      "name": "Send a text message JC",
      "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Deduplication: track processed messageIds in workflow static data\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.processedIds) staticData.processedIds = {};\n\nconst msgId = $json.messageId || $json.id || '';\nif (!msgId) {\n  throw new Error('No messageId found ‚Äî cannot deduplicate.');\n}\n\n// Clean up entries older than 24 hours\nconst now = Date.now();\nconst ONE_DAY = 24 * 60 * 60 * 1000;\nfor (const [key, ts] of Object.entries(staticData.processedIds)) {\n  if (now - ts > ONE_DAY) delete staticData.processedIds[key];\n}\n\nif (staticData.processedIds[msgId]) {\n  // Already processed ‚Äî stop execution for this item\n  return [];\n}\n\nstaticData.processedIds[msgId] = now;\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        752,
        2416
      ],
      "id": "736b9d6a-ddfc-4e20-8e88-b6a8e7f1e69f",
      "name": "Deduplicate"
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=üö® *ONBOARDING FAILURE ‚Äî JC PATH*\n\n‚ùå User creation failed at node: {{$json.error?.message || $json.errorMessage || 'Unknown error'}}\n\nüìß *Original request from:* {{$('Email Parser JC1').item.json.originalEmail?.from || 'Unknown'}}\nüë§ *Name:* {{$('Email Parser JC1').item.json.body?.firstname || '?'}} {{$('Email Parser JC1').item.json.body?.lastname || '?'}}\n\n‚è∞ {{new Date().toISOString()}}\n\nPlease investigate and process manually if needed.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1744,
        2048
      ],
      "id": "c7e08845-8ec9-4322-aa60-95484ad524ad",
      "name": "Error Alert JC",
      "webhookId": "c7e912bc-d583-4904-8cc6-b1b6edd9cbb1",
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      }
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=üö® *ONBOARDING FAILURE ‚Äî AD PATH*\n\n‚ùå User creation failed at node: {{$json.error?.message || $json.errorMessage || 'Unknown error'}}\n\nüìß *Original request from:* {{$('Email Parser AD1').item.json.originalEmail?.from || 'Unknown'}}\nüë§ *Name:* {{$('Email Parser AD1').item.json.body?.firstname || '?'}} {{$('Email Parser AD1').item.json.body?.lastname || '?'}}\n\n‚è∞ {{new Date().toISOString()}}\n\nPlease investigate and process manually if needed.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2016,
        2672
      ],
      "id": "0cfa1c9e-85ec-4c54-a54a-025c1e006eda",
      "name": "Error Alert AD",
      "webhookId": "813f62f4-4082-4190-a6e6-3904d3063856",
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      }
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "simple": false,
        "filters": {},
        "options": {}
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        576,
        2416
      ],
      "id": "1b894b63-0f8b-454c-94bf-0b0fda8ff031",
      "name": "Gmail Trigger1",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "7dd6a3f5-aa13-4fdc-88f8-a9798fbf925d",
                    "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                    "rightValue": "JC",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "3367d402-3127-4cf0-b3de-69d8cdc8cf90",
                    "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                    "rightValue": "AD",
                    "operator": {
                      "type": "string",
                      "operation": "contains"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        912,
        2416
      ],
      "id": "09a6cc17-1139-4680-80d1-614946108db7",
      "name": "Switch1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ===== JC EMAIL PARSER WITH SANITIZATION =====\n\n// ----- Sanitize helper -----\nfunction sanitize(val) {\n  if (!val || typeof val !== 'string') return '';\n  // Strip characters dangerous in PowerShell command strings\n  return val.replace(/[;'\"\\`$|&><\\\\{}()]/g, '').trim();\n}\n\n// ----- HTML to text -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  const text = html.replace(/<[^>]+>/g, ' ');\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\n// ----- 1) Get email body -----\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\n// ----- 3) Parse AND sanitize all fields -----\nconst userData = {\n  firstname:      sanitize(captureAfter('First Name', flat)),\n  lastname:       sanitize(captureAfter('Last Name', flat)),\n  employeenumber: sanitize(captureAfter('Employee Number', flat)),\n  jobtitle:       sanitize(captureAfter('Job Title', flat)),\n  department:     sanitize(captureAfter('Department', flat)),\n  managersam:     sanitize(captureAfter('Manager SAM', flat) || captureAfter('Manager', flat)),\n  officephone:    sanitize(captureAfter('Office Phone', flat) || captureAfter('Phone', flat)),\n  officelocation: sanitize(captureAfter('Office Location', flat) || captureAfter('Location', flat)),\n  sourceusername: sanitize(captureAfter('Source Username', flat)),\n};\n\n// ----- 4) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`[JC] Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match.`);\n}\n\n// ----- 5) Metadata -----\nconst subj = $json.subject || ($json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim()) || '';\nconst fromText = ($json.from?.text) || ($json.headers?.from?.replace(/^From:\\s*/i,'').trim()) || '';\nconst msgId = $json.messageId || ($json.headers?.['message-id']?.replace(/^Message-Id:\\s*/i,'').trim()) || '';\n\nreturn {\n  body: userData,\n  originalEmail: { subject: subj, from: fromText, messageId: msgId },\n  sanitized: true,\n  path: 'JC'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        2400
      ],
      "id": "8ecd79a7-3b95-4395-9dba-e88d542cd3df",
      "name": "Email Parser JC1"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ===== AD EMAIL PARSER WITH SANITIZATION =====\n\n// ----- Sanitize helper -----\nfunction sanitize(val) {\n  if (!val || typeof val !== 'string') return '';\n  return val.replace(/[;'\"\\`$|&><\\\\{}()]/g, '').trim();\n}\n\n// ----- HTML to text -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  const text = html.replace(/<[^>]+>/g, ' ');\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\n// ----- 1) Get email body -----\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\n// ----- 3) Parse AND sanitize all fields -----\nconst userData = {\n  firstname:      sanitize(captureAfter('First Name', flat)),\n  lastname:       sanitize(captureAfter('Last Name', flat)),\n  employeenumber: sanitize(captureAfter('Employee Number', flat)),\n  jobtitle:       sanitize(captureAfter('Job Title', flat)),\n  department:     sanitize(captureAfter('Department', flat)),\n  managersam:     sanitize(captureAfter('Manager SAM', flat) || captureAfter('Manager', flat)),\n  officephone:    sanitize(captureAfter('Office Phone', flat) || captureAfter('Phone', flat)),\n  officelocation: sanitize(captureAfter('Office Location', flat) || captureAfter('Location', flat)),\n  sourceusername: sanitize(captureAfter('Source Username', flat)),\n};\n\n// ----- 4) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`[AD] Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match.`);\n}\n\n// ----- 5) Metadata -----\nconst subj = $json.subject || ($json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim()) || '';\nconst fromText = ($json.from?.text) || ($json.headers?.from?.replace(/^From:\\s*/i,'').trim()) || '';\nconst msgId = $json.messageId || ($json.headers?.['message-id']?.replace(/^Message-Id:\\s*/i,'').trim()) || '';\n\nreturn {\n  body: userData,\n  originalEmail: { subject: subj, from: fromText, messageId: msgId },\n  sanitized: true,\n  path: 'AD'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1312,
        3088
      ],
      "id": "53660065-98c5-4810-a1e6-15135b8c6566",
      "name": "Email Parser AD1"
    },
    {
      "parameters": {
        "sendTo": "={{ $('Gmail Trigger1').item.json.from?.value?.map(v => v.address).join(', ') }}",
        "subject": "=Re: {{$('Gmail Trigger1').item.json.subject}} - Processing Started",
        "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1440,
        2032
      ],
      "id": "969cfe11-3291-40c5-9e64-07aac3c466c5",
      "name": "Send Acknowledgment JC1",
      "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $('Gmail Trigger1').item.json.from?.value?.map(v => v.address).join(', ') }}",
        "subject": "=Re: {{$('Gmail Trigger1').item.json.subject}} - Processing Started",
        "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1424,
        2640
      ],
      "id": "cefc4534-49b1-450d-b5fa-590559e5a952",
      "name": "Send Acknowledgment AD1",
      "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -Command \"& { C:\\Scripts\\Create-JCUser-From-n8n.ps1 -FirstName '{{$json[\"body\"][\"firstname\"]}}' -LastName '{{$json[\"body\"][\"lastname\"]}}' -EmployeeNumber '{{$json[\"body\"][\"employeenumber\"]}}' -JobTitle '{{$json[\"body\"][\"jobtitle\"]}}' -Department '{{$json[\"body\"][\"department\"]}}' -ManagerSam '{{$json[\"body\"][\"managersam\"]}}' -OfficePhone '{{$json[\"body\"][\"officephone\"]}}' -OfficeLocation '{{$json[\"body\"][\"officelocation\"]}}' -SourceUsername '{{$json[\"body\"][\"sourceusername\"]}}' }\"",
        "cwd": "="
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1776,
        2400
      ],
      "id": "da2615c9-8946-49da-99fa-3c99be5e8433",
      "name": "Create New JC User1",
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\Scripts\\Create-ADUser-From-n8n.ps1\" -FirstName \"{{$json[\"body\"][\"firstname\"]}}\" -LastName \"{{$json[\"body\"][\"lastname\"]}}\" -EmployeeNumber {{$json[\"body\"][\"employeenumber\"]}} -JobTitle \"{{$json[\"body\"][\"jobtitle\"]}}\" -Department \"{{$json[\"body\"][\"department\"]}}\" -ManagerSam \"{{$json[\"body\"][\"managersam\"]}}\" -OfficePhone \"{{$json[\"body\"][\"officephone\"]}}\" -OfficeLocation \"{{$json[\"body\"][\"officelocation\"]}}\" -SourceUsername \"{{$json[\"body\"][\"sourceusername\"]}}\"",
        "cwd": "="
      },
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        1792,
        3088
      ],
      "id": "2d60666f-06d8-43bd-9633-6ad98476d4de",
      "name": "Create New AD User1",
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      },
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"[JC] No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"[JC] Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"[JC] PowerShell script error: \" + out.error);\n}\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2048,
        2384
      ],
      "id": "3f20240b-f4b5-448b-ae34-8aa3182a39a3",
      "name": "PowerShell Output Parser JC1",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"[AD] No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"[AD] Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"[AD] PowerShell script error: \" + out.error);\n}\nreturn out;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2160,
        3072
      ],
      "id": "1936146d-f12b-42af-a1c7-0b4dba4b8baa",
      "name": "PowerShell Output Parser AD1",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C099QKJSCTD",
          "mode": "list",
          "cachedResultName": "new-user-created"
        },
        "text": "=ü§ñ *New JC User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüÜî *Username:* `{{$json[\"Username\"]}}`\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        2480,
        2608
      ],
      "id": "0892871b-c003-482c-b7cc-2ca80f87233f",
      "name": "Send a message JC1",
      "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "New JC User Created",
        "message": "=<h1 style=\"color:blue;\">ü§ñ New JC User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2464,
        2128
      ],
      "id": "37204639-5061-4c8f-b331-a32ce1e6ddb5",
      "name": "Send Message JC1",
      "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=ü§ñ *New JC User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Username:* {{$json[\"Username\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n{{$json[\"ConflictMessage\"]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2480,
        2384
      ],
      "id": "8d97092d-97b2-4829-8b9c-3e92c53e048e",
      "name": "Send a text message JC1",
      "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      }
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C099QKJSCTD",
          "mode": "list",
          "cachedResultName": "new-user-created"
        },
        "text": "=ü§ñ *New AD User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n‚úâÔ∏è *DL Groups:* {{ $json[\"DLGroupsCopied\"]?.length > 0 ? $json[\"DLGroupsCopied\"].join(', ') : '_None_' }}\nüõ°Ô∏è *Security Groups:* {{ $json[\"SecurityGroupsCopied\"]?.length > 0 ? $json[\"SecurityGroupsCopied\"].join(', ') : '_None_' }}\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
        "otherOptions": {}
      },
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.3,
      "position": [
        2512,
        3296
      ],
      "id": "b136d306-8374-4dff-8b42-bd268155a47e",
      "name": "Send a message AD1",
      "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
      "credentials": {
        "slackApi": {
          "id": "obEYVo8oQOJ22JqX",
          "name": "AD Admin Bot"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "New AD User Created",
        "message": "=<h1 style=\"color:blue;\">ü§ñ New AD User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2496,
        2864
      ],
      "id": "e881a9f1-f542-4ce2-8834-1218b9526c71",
      "name": "Send Message AD1",
      "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
      "executeOnce": false,
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "426570413",
        "text": "=ü§ñ *New AD User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n*DL Groups Copied:* {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}\n*Security Groups Copied:* {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}\n{{$json[\"ConflictMessage\"]}}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        2496,
        3088
      ],
      "id": "01fc7d27-e0e4-45c2-985e-2b29e9cb8a92",
      "name": "Send a text message AD1",
      "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
      "executeOnce": false,
      "credentials": {
        "telegramApi": {
          "id": "QH2SVpRQkhmpSDsN",
          "name": "Users Bot"
        }
      }
    }
  ],
  "connections": {
    "Create New AD User": {
      "main": [
        [
          {
            "node": "PowerShell Output Parser AD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Parser AD": {
      "main": [
        [
          {
            "node": "Send Acknowledgment AD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create New AD User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PowerShell Output Parser AD": {
      "main": [
        [
          {
            "node": "Send a message AD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message AD",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Message AD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New JC User": {
      "main": [
        [
          {
            "node": "PowerShell Output Parser JC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Email Parser JC",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Email Parser AD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Trigger": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Parser JC": {
      "main": [
        [
          {
            "node": "Create New JC User",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Acknowledgment JC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PowerShell Output Parser JC": {
      "main": [
        [
          {
            "node": "Send a message JC",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Message JC",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message JC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Deduplicate": {
      "main": [
        [
          {
            "node": "Switch1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Trigger1": {
      "main": [
        [
          {
            "node": "Deduplicate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch1": {
      "main": [
        [
          {
            "node": "Email Parser JC1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Email Parser AD1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Parser JC1": {
      "main": [
        [
          {
            "node": "Create New JC User1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Acknowledgment JC1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Parser AD1": {
      "main": [
        [
          {
            "node": "Send Acknowledgment AD1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create New AD User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New JC User1": {
      "main": [
        [
          {
            "node": "PowerShell Output Parser JC1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Alert JC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create New AD User1": {
      "main": [
        [
          {
            "node": "PowerShell Output Parser AD1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Alert AD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PowerShell Output Parser JC1": {
      "main": [
        [
          {
            "node": "Send a message JC1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Message JC1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message JC1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Alert JC",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "PowerShell Output Parser AD1": {
      "main": [
        [
          {
            "node": "Send a message AD1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a text message AD1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Message AD1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Error Alert AD",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {
    "node:Gmail Trigger": {
      "Gmail Trigger": {
        "lastTimeChecked": 1771649388,
        "possibleDuplicates": [
          "19c7e8853653e1f7",
          "19c7e86d6bdc1479"
        ]
      }
    },
    "node:Gmail Trigger1": {
      "Gmail Trigger1": {
        "lastTimeChecked": 1771655373
      }
    },
    "global": {
      "processedIds": {
        "<19c7ee5bfbe.ebe29605215836.7030557669023833208@alex-it.net>": 1771655525695,
        "<19c7ef57939.35f1276c1937591.2848522258597818721@alex-it.net>": 1771656606307,
        "<1067359882.21134768.1771658327338@ltx1-app42789.prod.linkedin.com>": 1771658406422,
        "<e597e46d4bf44d3eb3db133d44771617@aliexpress.com>": 1771658586442,
        "<1160293559.21388715.1771665566717@ltx1-app27158.prod.linkedin.com>": 1771665606181,
        "<UMkyMFQMRt601-IG8Ua_DA@geopod-ismtpd-38>": 1771666746102
      }
    }
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "pinData": {},
  "versionId": "f823af93-9051-4f89-b309-c0ce487c5fe4",
  "activeVersionId": "f823af93-9051-4f89-b309-c0ce487c5fe4",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2025-10-31T09:14:00.807Z",
      "createdAt": "2025-10-31T09:14:00.807Z",
      "role": "workflow:owner",
      "workflowId": "vb6sSMl5XrlcvUae",
      "projectId": "pWTWmuHnmIHw48U9"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-21T06:29:34.000Z",
    "createdAt": "2026-02-21T06:29:32.545Z",
    "versionId": "f823af93-9051-4f89-b309-c0ce487c5fe4",
    "workflowId": "vb6sSMl5XrlcvUae",
    "nodes": [
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\Scripts\\Create-ADUser-From-n8n.ps1\" -FirstName \"{{$json[\"body\"][\"firstname\"]}}\" -LastName \"{{$json[\"body\"][\"lastname\"]}}\" -EmployeeNumber {{$json[\"body\"][\"employeenumber\"]}} -JobTitle \"{{$json[\"body\"][\"jobtitle\"]}}\" -Department \"{{$json[\"body\"][\"department\"]}}\" -ManagerSam \"{{$json[\"body\"][\"managersam\"]}}\" -OfficePhone \"{{$json[\"body\"][\"officephone\"]}}\" -OfficeLocation \"{{$json[\"body\"][\"officelocation\"]}}\" -SourceUsername \"{{$json[\"body\"][\"sourceusername\"]}}\"",
          "cwd": "="
        },
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          368,
          416
        ],
        "id": "16e30789-dbad-4eb5-a9c3-3b5a50bebde4",
        "name": "Create New AD User",
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "sendTo": "={{ $('Gmail Trigger').item.json.from?.value?.map(v => v.address).join(', ') }}",
          "subject": "=Re: {{$('Gmail Trigger').item.json.subject}} - Processing Started",
          "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          0,
          -32
        ],
        "id": "e071b0fb-64e2-4f21-889f-f4a9a2a47d6e",
        "name": "Send Acknowledgment AD",
        "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "// ----- 1) Get the email body from this payload shape -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  // Normalize line breaks before stripping tags\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  // Strip tags\n  const text = html.replace(/<[^>]+>/g, ' ');\n  // Collapse whitespace\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\n// If body still empty, try base64-encoded Gmail payload (rare here but safe)\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\n// Safety: normalize whitespace for robust regex capture\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture (works for single-line or multiline) -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  // Accept either single-line or multiline values\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\nconst userData = {\n  firstname:      captureAfter('First Name', flat),\n  lastname:       captureAfter('Last Name', flat),\n  employeenumber: captureAfter('Employee Number', flat),\n  jobtitle:       captureAfter('Job Title', flat),\n  department:     captureAfter('Department', flat),\n  managersam:     captureAfter('Manager SAM', flat) || captureAfter('Manager', flat),\n  officephone:    captureAfter('Office Phone', flat) || captureAfter('Phone', flat),\n  officelocation: captureAfter('Office Location', flat) || captureAfter('Location', flat),\n  sourceusername: captureAfter('Source Username', flat),\n};\n\n// ----- 3) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match exactly.`);\n}\n\n// ----- 4) Subject/From/MessageId from this payload shape -----\nconst subj =\n  $json.subject ||\n  ($json.headers && typeof $json.headers.subject === 'string'\n    ? $json.headers.subject.replace(/^Subject:\\s*/i,'').trim()\n    : '');\n\nconst fromText =\n  ($json.from && $json.from.text) ||\n  ($json.headers && typeof $json.headers.from === 'string'\n    ? $json.headers.from.replace(/^From:\\s*/i,'').trim()\n    : '');\n\nconst msgId =\n  $json.messageId ||\n  ($json.headers && typeof $json.headers['message-id'] === 'string'\n    ? $json.headers['message-id'].replace(/^Message-Id:\\s*/i,'').trim()\n    : '');\n\n// ----- 5) Return in your expected shape -----\nreturn {\n  body: userData,\n  originalEmail: {\n    subject: subj,\n    from: fromText,\n    messageId: msgId,\n  },\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -112,
          416
        ],
        "id": "420d63d7-c0a9-4910-aa90-31f9d11472f2",
        "name": "Email Parser AD",
        "disabled": true
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"PowerShell script error: \" + out.error);\n}\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          784,
          416
        ],
        "id": "a76c1c8f-bc80-41d2-bc27-1df8b0c21a61",
        "name": "PowerShell Output Parser AD",
        "disabled": true
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C099QKJSCTD",
            "mode": "list",
            "cachedResultName": "new-user-created"
          },
          "text": "=ü§ñ *New JC User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüÜî *Username:* `{{$json[\"Username\"]}}`\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
          "otherOptions": {}
        },
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.3,
        "position": [
          1056,
          -64
        ],
        "id": "258060f6-6700-4e0b-bcaa-052d3d3e4d33",
        "name": "Send a message JC",
        "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "New AD user Created",
          "message": "=<h1 style=\"color:blue;\">ü§ñ New AD User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          1072,
          192
        ],
        "id": "1fecd824-667e-4228-8e53-920d098200ec",
        "name": "Send Message AD",
        "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
        "executeOnce": false,
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=ü§ñ *New AD User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n*DL Groups Copied:* {{$json[\"DLGroupsCopied\"].join(', ')}}\n*Security Groups Copied:* {{$json[\"SecurityGroupsCopied\"].join(', ')}}\n{{$json[\"ConflictMessage\"]}}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          1072,
          416
        ],
        "id": "b16cae5c-90fd-4b74-8395-3794884929eb",
        "name": "Send a text message AD",
        "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
        "executeOnce": false,
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C099QKJSCTD",
            "mode": "list",
            "cachedResultName": "new-user-created"
          },
          "text": "=ü§ñ *New AD User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n‚úâÔ∏è *DL Groups:* {{ $json[\"DLGroupsCopied\"].length > 0 ? $json[\"DLGroupsCopied\"].join(', ') : '_None_' }}\nüõ°Ô∏è *Security Groups:* {{ $json[\"SecurityGroupsCopied\"].length > 0 ? $json[\"SecurityGroupsCopied\"].join(', ') : '_None_' }}\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
          "otherOptions": {}
        },
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.3,
        "position": [
          1088,
          624
        ],
        "id": "98d17c73-ea6c-4117-b6a1-49b4deddfb51",
        "name": "Send a message AD",
        "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -Command \"& { C:\\Scripts\\Create-JCUser-From-n8n.ps1 -FirstName '{{$json[\"body\"][\"firstname\"]}}' -LastName '{{$json[\"body\"][\"lastname\"]}}' -EmployeeNumber '{{$json[\"body\"][\"employeenumber\"]}}' -JobTitle '{{$json[\"body\"][\"jobtitle\"]}}' -Department '{{$json[\"body\"][\"department\"]}}' -ManagerSam '{{$json[\"body\"][\"managersam\"]}}' -OfficePhone '{{$json[\"body\"][\"officephone\"]}}' -OfficeLocation '{{$json[\"body\"][\"officelocation\"]}}' }\"",
          "cwd": "="
        },
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          352,
          -272
        ],
        "id": "97f98a71-7f8f-46e2-9f29-ed666099cfd8",
        "name": "Create New JC User",
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "7dd6a3f5-aa13-4fdc-88f8-a9798fbf925d",
                      "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                      "rightValue": "JC",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "3367d402-3127-4cf0-b3de-69d8cdc8cf90",
                      "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                      "rightValue": "AD",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          -512,
          -256
        ],
        "id": "993a8e12-82d3-4d63-883a-9db0a1044125",
        "name": "Switch",
        "disabled": true
      },
      {
        "parameters": {
          "sendTo": "={{ $('Gmail Trigger').item.json.from?.value?.map(v => v.address).join(', ') }}",
          "subject": "=Re: {{$('Gmail Trigger').item.json.subject}} - Processing Started",
          "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          16,
          -640
        ],
        "id": "929d2895-9391-42c2-ad5b-5fa164d06798",
        "name": "Send Acknowledgment JC",
        "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "simple": false,
          "filters": {},
          "options": {}
        },
        "type": "n8n-nodes-base.gmailTrigger",
        "typeVersion": 1.3,
        "position": [
          -848,
          -256
        ],
        "id": "287481f1-9fd6-4e50-8a59-b2483c508a50",
        "name": "Gmail Trigger",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "// ----- 1) Get the email body from this payload shape -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  // Normalize line breaks before stripping tags\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  // Strip tags\n  const text = html.replace(/<[^>]+>/g, ' ');\n  // Collapse whitespace\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\n// If body still empty, try base64-encoded Gmail payload (rare here but safe)\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\n// Safety: normalize whitespace for robust regex capture\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture (works for single-line or multiline) -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  // Accept either single-line or multiline values\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\nconst userData = {\n  firstname:      captureAfter('First Name', flat),\n  lastname:       captureAfter('Last Name', flat),\n  employeenumber: captureAfter('Employee Number', flat),\n  jobtitle:       captureAfter('Job Title', flat),\n  department:     captureAfter('Department', flat),\n  managersam:     captureAfter('Manager SAM', flat) || captureAfter('Manager', flat),\n  officephone:    captureAfter('Office Phone', flat) || captureAfter('Phone', flat),\n  officelocation: captureAfter('Office Location', flat) || captureAfter('Location', flat),\n};\n\n// ----- 3) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match exactly.`);\n}\n\n// ----- 4) Subject/From/MessageId from this payload shape -----\nconst subj =\n  $json.subject ||\n  ($json.headers && typeof $json.headers.subject === 'string'\n    ? $json.headers.subject.replace(/^Subject:\\s*/i,'').trim()\n    : '');\n\nconst fromText =\n  ($json.from && $json.from.text) ||\n  ($json.headers && typeof $json.headers.from === 'string'\n    ? $json.headers.from.replace(/^From:\\s*/i,'').trim()\n    : '');\n\nconst msgId =\n  $json.messageId ||\n  ($json.headers && typeof $json.headers['message-id'] === 'string'\n    ? $json.headers['message-id'].replace(/^Message-Id:\\s*/i,'').trim()\n    : '');\n\n// ----- 5) Return in your expected shape -----\nreturn {\n  body: userData,\n  originalEmail: {\n    subject: subj,\n    from: fromText,\n    messageId: msgId,\n  },\n};\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -96,
          -272
        ],
        "id": "a650085a-e0d0-4205-9033-105259013c20",
        "name": "Email Parser JC",
        "disabled": true
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"PowerShell script error: \" + out.error);\n}\nreturn out;\n"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          608,
          -272
        ],
        "id": "a0e4d860-4076-4865-b5f5-a5c95b5ace91",
        "name": "PowerShell Output Parser JC",
        "disabled": true
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "New AD user Created",
          "message": "=<h1 style=\"color:blue;\">ü§ñ New JC User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"].join(', ')}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          1040,
          -544
        ],
        "id": "9c12337d-cfbd-42bb-bcda-8f0b61dfa8af",
        "name": "Send Message JC",
        "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
        "executeOnce": false,
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=ü§ñ *New JC User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Username:* {{$json[\"Username\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n{{$json[\"ConflictMessage\"]}}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          1056,
          -288
        ],
        "id": "62c0c511-99ec-449b-a85e-931f64cd7636",
        "name": "Send a text message JC",
        "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
        "executeOnce": false,
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        },
        "disabled": true
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "// Deduplication: track processed messageIds in workflow static data\nconst staticData = $getWorkflowStaticData('global');\nif (!staticData.processedIds) staticData.processedIds = {};\n\nconst msgId = $json.messageId || $json.id || '';\nif (!msgId) {\n  throw new Error('No messageId found ‚Äî cannot deduplicate.');\n}\n\n// Clean up entries older than 24 hours\nconst now = Date.now();\nconst ONE_DAY = 24 * 60 * 60 * 1000;\nfor (const [key, ts] of Object.entries(staticData.processedIds)) {\n  if (now - ts > ONE_DAY) delete staticData.processedIds[key];\n}\n\nif (staticData.processedIds[msgId]) {\n  // Already processed ‚Äî stop execution for this item\n  return [];\n}\n\nstaticData.processedIds[msgId] = now;\nreturn $json;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          752,
          2416
        ],
        "id": "736b9d6a-ddfc-4e20-8e88-b6a8e7f1e69f",
        "name": "Deduplicate"
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=üö® *ONBOARDING FAILURE ‚Äî JC PATH*\n\n‚ùå User creation failed at node: {{$json.error?.message || $json.errorMessage || 'Unknown error'}}\n\nüìß *Original request from:* {{$('Email Parser JC1').item.json.originalEmail?.from || 'Unknown'}}\nüë§ *Name:* {{$('Email Parser JC1').item.json.body?.firstname || '?'}} {{$('Email Parser JC1').item.json.body?.lastname || '?'}}\n\n‚è∞ {{new Date().toISOString()}}\n\nPlease investigate and process manually if needed.",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          1744,
          2048
        ],
        "id": "c7e08845-8ec9-4322-aa60-95484ad524ad",
        "name": "Error Alert JC",
        "webhookId": "c7e912bc-d583-4904-8cc6-b1b6edd9cbb1",
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        }
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=üö® *ONBOARDING FAILURE ‚Äî AD PATH*\n\n‚ùå User creation failed at node: {{$json.error?.message || $json.errorMessage || 'Unknown error'}}\n\nüìß *Original request from:* {{$('Email Parser AD1').item.json.originalEmail?.from || 'Unknown'}}\nüë§ *Name:* {{$('Email Parser AD1').item.json.body?.firstname || '?'}} {{$('Email Parser AD1').item.json.body?.lastname || '?'}}\n\n‚è∞ {{new Date().toISOString()}}\n\nPlease investigate and process manually if needed.",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          2016,
          2672
        ],
        "id": "0cfa1c9e-85ec-4c54-a54a-025c1e006eda",
        "name": "Error Alert AD",
        "webhookId": "813f62f4-4082-4190-a6e6-3904d3063856",
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        }
      },
      {
        "parameters": {
          "pollTimes": {
            "item": [
              {
                "mode": "everyMinute"
              }
            ]
          },
          "simple": false,
          "filters": {},
          "options": {}
        },
        "type": "n8n-nodes-base.gmailTrigger",
        "typeVersion": 1.3,
        "position": [
          576,
          2416
        ],
        "id": "1b894b63-0f8b-454c-94bf-0b0fda8ff031",
        "name": "Gmail Trigger1",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "rules": {
            "values": [
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "7dd6a3f5-aa13-4fdc-88f8-a9798fbf925d",
                      "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                      "rightValue": "JC",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              },
              {
                "conditions": {
                  "options": {
                    "caseSensitive": true,
                    "leftValue": "",
                    "typeValidation": "strict",
                    "version": 2
                  },
                  "conditions": [
                    {
                      "id": "3367d402-3127-4cf0-b3de-69d8cdc8cf90",
                      "leftValue": "={{$json.subject || $json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim() || ''}}",
                      "rightValue": "AD",
                      "operator": {
                        "type": "string",
                        "operation": "contains"
                      }
                    }
                  ],
                  "combinator": "and"
                }
              }
            ]
          },
          "options": {}
        },
        "type": "n8n-nodes-base.switch",
        "typeVersion": 3.2,
        "position": [
          912,
          2416
        ],
        "id": "09a6cc17-1139-4680-80d1-614946108db7",
        "name": "Switch1"
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "// ===== JC EMAIL PARSER WITH SANITIZATION =====\n\n// ----- Sanitize helper -----\nfunction sanitize(val) {\n  if (!val || typeof val !== 'string') return '';\n  // Strip characters dangerous in PowerShell command strings\n  return val.replace(/[;'\"\\`$|&><\\\\{}()]/g, '').trim();\n}\n\n// ----- HTML to text -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  const text = html.replace(/<[^>]+>/g, ' ');\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\n// ----- 1) Get email body -----\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\n// ----- 3) Parse AND sanitize all fields -----\nconst userData = {\n  firstname:      sanitize(captureAfter('First Name', flat)),\n  lastname:       sanitize(captureAfter('Last Name', flat)),\n  employeenumber: sanitize(captureAfter('Employee Number', flat)),\n  jobtitle:       sanitize(captureAfter('Job Title', flat)),\n  department:     sanitize(captureAfter('Department', flat)),\n  managersam:     sanitize(captureAfter('Manager SAM', flat) || captureAfter('Manager', flat)),\n  officephone:    sanitize(captureAfter('Office Phone', flat) || captureAfter('Phone', flat)),\n  officelocation: sanitize(captureAfter('Office Location', flat) || captureAfter('Location', flat)),\n  sourceusername: sanitize(captureAfter('Source Username', flat)),\n};\n\n// ----- 4) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`[JC] Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match.`);\n}\n\n// ----- 5) Metadata -----\nconst subj = $json.subject || ($json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim()) || '';\nconst fromText = ($json.from?.text) || ($json.headers?.from?.replace(/^From:\\s*/i,'').trim()) || '';\nconst msgId = $json.messageId || ($json.headers?.['message-id']?.replace(/^Message-Id:\\s*/i,'').trim()) || '';\n\nreturn {\n  body: userData,\n  originalEmail: { subject: subj, from: fromText, messageId: msgId },\n  sanitized: true,\n  path: 'JC'\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1328,
          2400
        ],
        "id": "8ecd79a7-3b95-4395-9dba-e88d542cd3df",
        "name": "Email Parser JC1"
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "// ===== AD EMAIL PARSER WITH SANITIZATION =====\n\n// ----- Sanitize helper -----\nfunction sanitize(val) {\n  if (!val || typeof val !== 'string') return '';\n  return val.replace(/[;'\"\\`$|&><\\\\{}()]/g, '').trim();\n}\n\n// ----- HTML to text -----\nfunction htmlToText(html) {\n  if (!html) return '';\n  html = html\n    .replace(/<br\\s*\\/?>/gi, '\\n')\n    .replace(/<\\/(p|div|li|tr|h\\d)>/gi, '\\n')\n    .replace(/&nbsp;/gi, ' ');\n  const text = html.replace(/<[^>]+>/g, ' ');\n  return text.replace(/\\r?\\n/g, '\\n').replace(/[ \\t]+\\n/g, '\\n').replace(/[ \\t]{2,}/g, ' ').trim();\n}\n\n// ----- 1) Get email body -----\nlet emailBody =\n  ($json.text && String($json.text)) ||\n  htmlToText($json.html) ||\n  htmlToText($json.textAsHtml) ||\n  ($json.snippet && String($json.snippet)) ||\n  '';\n\nif (!emailBody && $json.payload && $json.payload.body && $json.payload.body.data) {\n  try {\n    const buff = Buffer.from($json.payload.body.data, 'base64');\n    emailBody = buff.toString('utf8');\n  } catch (_) {}\n}\n\nconst flat = (emailBody || '').replace(/\\r/g, '').replace(/[ \\t]+/g, ' ').trim();\n\n// ----- 2) Robust field capture -----\nconst LABELS = [\n  'First Name','Last Name','Employee Number','Job Title',\n  'Department','Manager SAM','Manager','Office Phone','Phone',\n  'Office Location','Location','Source Username'\n];\n\nfunction esc(s){ return s.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&'); }\n\nfunction captureAfter(label, src) {\n  const labelEsc = esc(label);\n  const next = LABELS.filter(l => l !== label).map(esc);\n  const lookahead = next.length ? `(?=\\\\s*(?:${next.join('|')})\\\\s*:|$)` : '$';\n  const re = new RegExp(`${labelEsc}\\\\s*:\\\\s*([\\\\s\\\\S]*?)\\\\s*${lookahead}`, 'i');\n  const m = src.match(re);\n  return m ? m[1].trim() : '';\n}\n\n// ----- 3) Parse AND sanitize all fields -----\nconst userData = {\n  firstname:      sanitize(captureAfter('First Name', flat)),\n  lastname:       sanitize(captureAfter('Last Name', flat)),\n  employeenumber: sanitize(captureAfter('Employee Number', flat)),\n  jobtitle:       sanitize(captureAfter('Job Title', flat)),\n  department:     sanitize(captureAfter('Department', flat)),\n  managersam:     sanitize(captureAfter('Manager SAM', flat) || captureAfter('Manager', flat)),\n  officephone:    sanitize(captureAfter('Office Phone', flat) || captureAfter('Phone', flat)),\n  officelocation: sanitize(captureAfter('Office Location', flat) || captureAfter('Location', flat)),\n  sourceusername: sanitize(captureAfter('Source Username', flat)),\n};\n\n// ----- 4) Validate required fields -----\nconst required = ['firstname','lastname','employeenumber','jobtitle','department','managersam'];\nconst missing = required.filter(f => !userData[f] || userData[f].trim() === '');\nif (missing.length) {\n  throw new Error(`[AD] Missing required fields: ${missing.join(', ')}. Parsed body was empty or labels didn't match.`);\n}\n\n// ----- 5) Metadata -----\nconst subj = $json.subject || ($json.headers?.subject?.replace(/^Subject:\\s*/i,'').trim()) || '';\nconst fromText = ($json.from?.text) || ($json.headers?.from?.replace(/^From:\\s*/i,'').trim()) || '';\nconst msgId = $json.messageId || ($json.headers?.['message-id']?.replace(/^Message-Id:\\s*/i,'').trim()) || '';\n\nreturn {\n  body: userData,\n  originalEmail: { subject: subj, from: fromText, messageId: msgId },\n  sanitized: true,\n  path: 'AD'\n};"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          1312,
          3088
        ],
        "id": "53660065-98c5-4810-a1e6-15135b8c6566",
        "name": "Email Parser AD1"
      },
      {
        "parameters": {
          "sendTo": "={{ $('Gmail Trigger1').item.json.from?.value?.map(v => v.address).join(', ') }}",
          "subject": "=Re: {{$('Gmail Trigger1').item.json.subject}} - Processing Started",
          "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          1440,
          2032
        ],
        "id": "969cfe11-3291-40c5-9e64-07aac3c466c5",
        "name": "Send Acknowledgment JC1",
        "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "={{ $('Gmail Trigger1').item.json.from?.value?.map(v => v.address).join(', ') }}",
          "subject": "=Re: {{$('Gmail Trigger1').item.json.subject}} - Processing Started",
          "message": "=<h2 style=\"color:blue;\">üìß User Creation Request Received</h2>\n\n<p>Thank you for your user creation request. We have received your email and are processing the following information:</p>\n\n<ul>\n<li><b>First Name:</b> {{$json[\"body\"][\"firstname\"]}}</li>\n<li><b>Last Name:</b> {{$json[\"body\"][\"lastname\"]}}</li>\n<li><b>Employee Number:</b> {{$json[\"body\"][\"employeenumber\"]}}</li>\n<li><b>Job Title:</b> {{$json[\"body\"][\"jobtitle\"]}}</li>\n<li><b>Department:</b> {{$json[\"body\"][\"department\"]}}</li>\n<li><b>Manager SAM:</b> {{$json[\"body\"][\"managersam\"]}}</li>\n<li><b>Office Phone:</b> {{$json[\"body\"][\"officephone\"] || 'Not provided'}}</li>\n<li><b>Office Location:</b> {{$json[\"body\"][\"officelocation\"] || 'Not provided'}}</li>\n</ul>\n\n<p style=\"color:green;\"><b>Status:</b> Processing...</p>\n<p>You will receive another notification once the user account has been created successfully.</p>\n\n<hr>\n<small>This is an automated message from Alex IT Systems.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          1424,
          2640
        ],
        "id": "cefc4534-49b1-450d-b5fa-590559e5a952",
        "name": "Send Acknowledgment AD1",
        "webhookId": "799b1b4d-00fd-4a0c-890c-9991db9a7c75",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -Command \"& { C:\\Scripts\\Create-JCUser-From-n8n.ps1 -FirstName '{{$json[\"body\"][\"firstname\"]}}' -LastName '{{$json[\"body\"][\"lastname\"]}}' -EmployeeNumber '{{$json[\"body\"][\"employeenumber\"]}}' -JobTitle '{{$json[\"body\"][\"jobtitle\"]}}' -Department '{{$json[\"body\"][\"department\"]}}' -ManagerSam '{{$json[\"body\"][\"managersam\"]}}' -OfficePhone '{{$json[\"body\"][\"officephone\"]}}' -OfficeLocation '{{$json[\"body\"][\"officelocation\"]}}' -SourceUsername '{{$json[\"body\"][\"sourceusername\"]}}' }\"",
          "cwd": "="
        },
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          1776,
          2400
        ],
        "id": "da2615c9-8946-49da-99fa-3c99be5e8433",
        "name": "Create New JC User1",
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:\\Scripts\\Create-ADUser-From-n8n.ps1\" -FirstName \"{{$json[\"body\"][\"firstname\"]}}\" -LastName \"{{$json[\"body\"][\"lastname\"]}}\" -EmployeeNumber {{$json[\"body\"][\"employeenumber\"]}} -JobTitle \"{{$json[\"body\"][\"jobtitle\"]}}\" -Department \"{{$json[\"body\"][\"department\"]}}\" -ManagerSam \"{{$json[\"body\"][\"managersam\"]}}\" -OfficePhone \"{{$json[\"body\"][\"officephone\"]}}\" -OfficeLocation \"{{$json[\"body\"][\"officelocation\"]}}\" -SourceUsername \"{{$json[\"body\"][\"sourceusername\"]}}\"",
          "cwd": "="
        },
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          1792,
          3088
        ],
        "id": "2d60666f-06d8-43bd-9633-6ad98476d4de",
        "name": "Create New AD User1",
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        },
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"[JC] No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"[JC] Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"[JC] PowerShell script error: \" + out.error);\n}\nreturn out;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2048,
          2384
        ],
        "id": "3f20240b-f4b5-448b-ae34-8aa3182a39a3",
        "name": "PowerShell Output Parser JC1",
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "mode": "runOnceForEachItem",
          "jsCode": "if (!$json[\"stdout\"] || $json[\"stdout\"].trim() === \"\") {\n  throw new Error(\"[AD] No JSON output received from PowerShell script. Stdout was empty.\");\n}\nlet out;\ntry {\n  out = JSON.parse($json[\"stdout\"]);\n} catch (e) {\n  throw new Error(\"[AD] Failed to parse JSON from PowerShell script: \" + e.message + \"\\n\\nOutput was:\\n\" + $json[\"stdout\"]);\n}\nif (out.error) {\n  throw new Error(\"[AD] PowerShell script error: \" + out.error);\n}\nreturn out;"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          2160,
          3072
        ],
        "id": "1936146d-f12b-42af-a1c7-0b4dba4b8baa",
        "name": "PowerShell Output Parser AD1",
        "onError": "continueErrorOutput"
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C099QKJSCTD",
            "mode": "list",
            "cachedResultName": "new-user-created"
          },
          "text": "=ü§ñ *New JC User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüÜî *Username:* `{{$json[\"Username\"]}}`\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
          "otherOptions": {}
        },
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.3,
        "position": [
          2480,
          2608
        ],
        "id": "0892871b-c003-482c-b7cc-2ca80f87233f",
        "name": "Send a message JC1",
        "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "New JC User Created",
          "message": "=<h1 style=\"color:blue;\">ü§ñ New JC User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          2464,
          2128
        ],
        "id": "37204639-5061-4c8f-b331-a32ce1e6ddb5",
        "name": "Send Message JC1",
        "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
        "executeOnce": false,
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=ü§ñ *New JC User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Username:* {{$json[\"Username\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n{{$json[\"ConflictMessage\"]}}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          2480,
          2384
        ],
        "id": "8d97092d-97b2-4829-8b9c-3e92c53e048e",
        "name": "Send a text message JC1",
        "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
        "executeOnce": false,
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        }
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C099QKJSCTD",
            "mode": "list",
            "cachedResultName": "new-user-created"
          },
          "text": "=ü§ñ *New AD User Created Successfully!*\n\nüë§ *First Name:* {{$json[\"FirstName\"]}}\nüë• *Last Name:* {{$json[\"LastName\"]}}\nüî¢ *Employee ID:* `{{$json[\"EmployeeNumber\"]}}`\nüíº *Job Title:* {{$json[\"JobTitle\"]}}\nüè¢ *Department:* {{$json[\"Department\"]}}\nüëî *Manager:* {{$json[\"Manager\"]}}\nüìç *Office Location:* {{$json[\"OfficeLocation\"]}}\nüìû *Phone:* {{$json[\"OfficePhone\"]}}\nüìß *Email:* {{$json[\"Email\"]}}\nüîë *Password:* `{{$json[\"Password\"]}}`\n\n‚úâÔ∏è *DL Groups:* {{ $json[\"DLGroupsCopied\"]?.length > 0 ? $json[\"DLGroupsCopied\"].join(', ') : '_None_' }}\nüõ°Ô∏è *Security Groups:* {{ $json[\"SecurityGroupsCopied\"]?.length > 0 ? $json[\"SecurityGroupsCopied\"].join(', ') : '_None_' }}\n\n{{$json[\"ConflictMessage\"] ? '‚ö†Ô∏è *Note:* ' + $json[\"ConflictMessage\"] : '‚úÖ No conflicts detected.'}}",
          "otherOptions": {}
        },
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.3,
        "position": [
          2512,
          3296
        ],
        "id": "b136d306-8374-4dff-8b42-bd268155a47e",
        "name": "Send a message AD1",
        "webhookId": "619d4034-0d7d-43f0-9691-ea960aef7115",
        "credentials": {
          "slackApi": {
            "id": "obEYVo8oQOJ22JqX",
            "name": "AD Admin Bot"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "New AD User Created",
          "message": "=<h1 style=\"color:blue;\">ü§ñ New AD User Created:</h1>\n\n<p style=\"color:black; font-size:1.1em;\"><b>First Name:</b> {{$json[\"FirstName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Last Name:</b> {{$json[\"LastName\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Employee Number:</b> {{$json[\"EmployeeNumber\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Department:</b> {{$json[\"Department\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Job Title:</b> {{$json[\"JobTitle\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Username:</b> {{$json[\"Username\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Manager:</b> {{$json[\"Manager\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Location:</b> {{$json[\"OfficeLocation\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Office Phone:</b> {{$json[\"OfficePhone\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>E-mail:</b> {{$json[\"Email\"]}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>DL Groups Copied:</b> {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:black; font-size:1.1em;\"><b>Security Groups Copied:</b> {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}</p>\n<p style=\"color:red; font-size:1.3em;\"><b>Initial Password:</b> <code>{{$json[\"Password\"]}}</code></p>\n<p style=\"color:red; font-size:1.1em;\"><b>Make sure to save the initial password in a safe location!</b></p>\n<p style=\"color:green; font-size:1.3em;\"><b>Alex IT</b></p>\n<hr>\n<small>This is an automated message. Do not reply.</small>",
          "options": {}
        },
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2.1,
        "position": [
          2496,
          2864
        ],
        "id": "e881a9f1-f542-4ce2-8834-1218b9526c71",
        "name": "Send Message AD1",
        "webhookId": "961eced4-af4c-4015-a632-1c5dcecb5a5f",
        "executeOnce": false,
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "chatId": "426570413",
          "text": "=ü§ñ *New AD User Created Successfully!*\n\n*First Name:* {{$json[\"FirstName\"]}}\n*Last Name:* {{$json[\"LastName\"]}}\n*Employee Number:* {{$json[\"EmployeeNumber\"]}}\n*Job Title:* {{$json[\"JobTitle\"]}}\n*Department:* {{$json[\"Department\"]}}\n*Manager:* {{$json[\"Manager\"]}}\n*Office Location:* {{$json[\"OfficeLocation\"]}}\n*Phone:* {{$json[\"OfficePhone\"]}}\n*Email:* {{$json[\"Email\"]}}\n*Password:* `{{$json[\"Password\"]}}`\n*DL Groups Copied:* {{$json[\"DLGroupsCopied\"]?.join(', ') || 'None'}}\n*Security Groups Copied:* {{$json[\"SecurityGroupsCopied\"]?.join(', ') || 'None'}}\n{{$json[\"ConflictMessage\"]}}",
          "additionalFields": {}
        },
        "type": "n8n-nodes-base.telegram",
        "typeVersion": 1.2,
        "position": [
          2496,
          3088
        ],
        "id": "01fc7d27-e0e4-45c2-985e-2b29e9cb8a92",
        "name": "Send a text message AD1",
        "webhookId": "ae9b49c5-f740-4d7f-b4af-c7ce2935e45f",
        "executeOnce": false,
        "credentials": {
          "telegramApi": {
            "id": "QH2SVpRQkhmpSDsN",
            "name": "Users Bot"
          }
        }
      }
    ],
    "connections": {
      "Create New AD User": {
        "main": [
          [
            {
              "node": "PowerShell Output Parser AD",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Email Parser AD": {
        "main": [
          [
            {
              "node": "Send Acknowledgment AD",
              "type": "main",
              "index": 0
            },
            {
              "node": "Create New AD User",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "PowerShell Output Parser AD": {
        "main": [
          [
            {
              "node": "Send a message AD",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send a text message AD",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Message AD",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create New JC User": {
        "main": [
          [
            {
              "node": "PowerShell Output Parser JC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch": {
        "main": [
          [
            {
              "node": "Email Parser JC",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Email Parser AD",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gmail Trigger": {
        "main": [
          [
            {
              "node": "Switch",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Email Parser JC": {
        "main": [
          [
            {
              "node": "Create New JC User",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Acknowledgment JC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "PowerShell Output Parser JC": {
        "main": [
          [
            {
              "node": "Send a message JC",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Message JC",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send a text message JC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Deduplicate": {
        "main": [
          [
            {
              "node": "Switch1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Gmail Trigger1": {
        "main": [
          [
            {
              "node": "Deduplicate",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Switch1": {
        "main": [
          [
            {
              "node": "Email Parser JC1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Email Parser AD1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Email Parser JC1": {
        "main": [
          [
            {
              "node": "Create New JC User1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Acknowledgment JC1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Email Parser AD1": {
        "main": [
          [
            {
              "node": "Send Acknowledgment AD1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Create New AD User1",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create New JC User1": {
        "main": [
          [
            {
              "node": "PowerShell Output Parser JC1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Error Alert JC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Create New AD User1": {
        "main": [
          [
            {
              "node": "PowerShell Output Parser AD1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Error Alert AD",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "PowerShell Output Parser JC1": {
        "main": [
          [
            {
              "node": "Send a message JC1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Message JC1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send a text message JC1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Error Alert JC",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "PowerShell Output Parser AD1": {
        "main": [
          [
            {
              "node": "Send a message AD1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send a text message AD1",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Message AD1",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "Error Alert AD",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Alex Vinokur",
    "name": "Version f823af93",
    "description": "",
    "autosaved": false
  },
  "tags": []
}