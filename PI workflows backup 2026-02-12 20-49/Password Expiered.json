{
  "updatedAt": "2026-02-12T15:15:46.868Z",
  "createdAt": "2026-02-12T12:50:02.597Z",
  "id": "Xy5FO273WkJQcpOO",
  "name": "Password Expiered",
  "active": true,
  "isArchived": false,
  "nodes": [
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        -96,
        2208
      ],
      "id": "52c21ff1-78d6-4cf6-be2b-2361a28db8de",
      "name": "Aggregate All Items"
    },
    {
      "parameters": {
        "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Password-Expiry.ps1\"",
        "cwd": "="
      },
      "id": "5a3097f1-8092-4e8e-9efe-f8fd78063d15",
      "name": "Run Password Expiry Script",
      "type": "n8n-nodes-base.ssh",
      "typeVersion": 1,
      "position": [
        -896,
        2208
      ],
      "credentials": {
        "sshPassword": {
          "id": "umWU43lA8b3R4GcA",
          "name": "SSH Password account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Debug: Log raw output\nconst rawStdout = $input.first().json.stdout;\nconsole.log('Raw stdout:', rawStdout);\nconsole.log('Stdout type:', typeof rawStdout);\nconsole.log('Stdout length:', rawStdout ? rawStdout.length : 0);\n\n// Check if we have any output\nif (!rawStdout || rawStdout.trim() === '') {\n  console.error('No output from PowerShell script');\n  return { json: { data: [], error: 'No output from script', debug: 'Empty stdout' } };\n}\n\nlet parsedData = null;\n\ntry {\n  // Try to parse as JSON\n  parsedData = JSON.parse(rawStdout);\n  console.log('Successfully parsed JSON:', parsedData);\n} catch (parseError) {\n  console.error('JSON parse failed:', parseError.message);\n  console.error('Attempted to parse:', rawStdout.substring(0, 500));\n  \n  // Try to extract JSON from mixed output\n  const jsonMatch = rawStdout.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsedData = JSON.parse(jsonMatch[0]);\n      console.log('Extracted JSON from mixed output');\n    } catch (e) {\n      console.error('Failed to extract JSON:', e.message);\n      return { json: { data: [], error: 'Failed to parse JSON', raw: rawStdout.substring(0, 200) } };\n    }\n  } else {\n    return { json: { data: [], error: 'No JSON found in output', raw: rawStdout.substring(0, 200) } };\n  }\n}\n\n// Extract data array\nconst data = parsedData.Data || parsedData.data || [];\nconsole.log('Extracted data array, count:', data.length);\n\nif (!Array.isArray(data)) {\n  console.error('Data is not an array:', typeof data);\n  return { json: { data: [], error: 'Data is not an array' } };\n}\n\n// Return properly formatted items\nconst result = data.map((user, index) => {\n  console.log(`Processing user ${index}:`, user);\n  \n  return {\n    json: {\n      username: user.Username || user.username || '',\n      fullname: user.FullName || user.fullname || user.FullName || '',\n      email: user.Email || user.email || '',\n      expiryDate: user.ExpiryDate || user.expiryDate || '',\n      daysUntilExpiry: parseInt(user.DaysUntilExpiry || user.daysUntilExpiry || 0),\n      lastPasswordChange: user.LastPasswordChange || user.lastPasswordChange || '',\n      passwordNeverExpires: user.PasswordNeverExpires || user.passwordNeverExpires || false\n    }\n  };\n});\n\nconsole.log('Parsed result count:', result.length);\nif (result.length > 0) {\n  console.log('First result:', result[0]);\n}\n\nreturn result;"
      },
      "id": "c3e330fb-b264-4bdd-9f51-931f9ccb9c3a",
      "name": "Parse Password Expiry Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        2208
      ]
    },
    {
      "parameters": {
        "jsCode": "const currentUsers = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertedDate = staticData.lastAlertedDate || {};\n\nconst today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\nreturn currentUsers.filter(item => {\n  const user = item.json.username;\n  const lastDate = staticData.lastAlertedDate[user];\n\n  // Only alert once per day\n  if (lastDate !== today) {\n    staticData.lastAlertedDate[user] = today;\n    return true;\n  }\n  return false;\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -336,
        2208
      ],
      "id": "4be33b04-75ec-4ca2-88e3-e2916fa01b0e",
      "name": "Check Memory"
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{ Object.keys($json).length > 0 ? 1 : 0 }}",
              "operation": "larger"
            }
          ]
        }
      },
      "id": "6f401897-aaf0-4549-9a37-f229cd013e7a",
      "name": "Any expired/expiring?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        608,
        1552
      ]
    },
    {
      "parameters": {},
      "id": "782b7ce2-6b99-4318-bd51-aa75c5e414db",
      "name": "No Events",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        784,
        2240
      ]
    },
    {
      "parameters": {
        "select": "channel",
        "channelId": {
          "__rl": true,
          "value": "C0AE6LM59QF",
          "mode": "id"
        },
        "text": "=üîê *PASSWORD EXPIRY ALERT* (Total: {{ $json.data.length }})\n_________________________________________\n\n{{ $json.data.map(user => {\n  const daysLeft = user.daysUntilExpiry || 0;\n  const emoji = daysLeft <= 0 ? '‚õî' : (daysLeft <= 3 ? 'üî¥' : (daysLeft <= 7 ? 'üü†' : 'üü°'));\n  const username = user.username || 'N/A';\n  const fullname = user.fullname || 'N/A';\n  const expiryDate = user.expiryDate || 'N/A';\n  \nreturn `${emoji} *${fullname}*\nüÜî Username: \\`${username}\\`\nüìÖ Expires: ${expiryDate}\n‚è±Ô∏è Days Left: *${daysLeft}*`;\n}).join('\\n\\n') }}\n\n_________________________________________\n‚ö†Ô∏è *Action:* _Users should change their passwords before expiry. Expired accounts may be locked out._\n",
        "otherOptions": {}
      },
      "id": "ba1026ee-7e54-47d7-b612-c082361f1898",
      "name": "Send Slack Alert",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.4,
      "position": [
        800,
        2048
      ],
      "webhookId": "ffc3f21e-c64d-4948-b8c2-f33c999ea7d7",
      "credentials": {
        "slackApi": {
          "id": "D411sZ9Jy82H8sJ8",
          "name": "Slack Password Bot"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "vinokura@alex-it.net",
        "subject": "={{ \"üîê ALERT: \" + $json.expiringCount + \" Password(s) Expiry Alert!\" }}",
        "message": "={{ $json.emailHtml }}",
        "options": {}
      },
      "id": "e610b00f-7b26-4546-9921-67f4d9a921eb",
      "name": "Send Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2,
      "position": [
        816,
        1840
      ],
      "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
      "credentials": {
        "gmailOAuth2": {
          "id": "C5742Grqr9Rpnxid",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Safely extract and aggregate data\nconst allItems = $input.all();\nconsole.log('Input items:', allItems.length);\n\nif (!allItems || allItems.length === 0) {\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Get the aggregated data\nconst firstItem = allItems[0].json;\nconsole.log('First item structure:', Object.keys(firstItem));\n\n// If data is already aggregated in json.data array\nlet usersData = [];\nif (firstItem.data && Array.isArray(firstItem.data)) {\n  usersData = firstItem.data;\n  console.log('Got users from data array:', usersData.length);\n} else if (firstItem.username) {\n  // Individual user items\n  usersData = allItems.map(item => item.json);\n  console.log('Got users from individual items:', usersData.length);\n}\n\nif (!usersData || usersData.length === 0) {\n  console.error('No user data found');\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Build HTML table\nconst tableRows = usersData.map(user => {\n  const daysLeft = parseInt(user.daysUntilExpiry || user.DaysUntilExpiry || 0);\n  const statusColor = daysLeft <= 0 ? '#e74c3c' : (daysLeft <= 3 ? '#e67e22' : (daysLeft <= 7 ? '#f39c12' : '#27ae60'));\n  const statusText = daysLeft <= 0 ? 'EXPIRED' : `${daysLeft} Days`;\n  const username = user.username || user.Username || '';\n  const fullname = user.fullname || user.FullName || '';\n  const email = user.email || user.Email || 'N/A';\n  const expiryDate = user.expiryDate || user.ExpiryDate || 'N/A';\n  \n  console.log(`Building row for ${username}: ${daysLeft} days`);\n  \n  return `\n    <tr style=\"border-bottom: 1px solid #eee;\">\n      <td style=\"padding: 12px; font-weight: 500;\">${username}</td>\n      <td style=\"padding: 12px;\">${fullname}</td>\n      <td style=\"padding: 12px;\">${email}</td>\n      <td style=\"padding: 12px; color: white; font-weight: bold; background-color: ${statusColor}; border-radius: 4px; text-align: center;\">\n        ${statusText}\n      </td>\n      <td style=\"padding: 12px;\">${expiryDate}</td>\n    </tr>`;\n}).join('');\n\nconst expiringCount = usersData.length;\nconst criticalCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 3).length;\nconst expiredCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 0).length;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .header { background-color: #2c3e50; color: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .header p { margin: 5px 0 0 0; opacity: 0.9; }\n    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n    .summary-card { background: white; padding: 15px; border-radius: 4px; border-left: 4px solid #3498db; }\n    .summary-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }\n    .summary-card .number { font-size: 32px; font-weight: bold; color: #2c3e50; }\n    .table-container { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .table-container h2 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }\n    table { width: 100%; border-collapse: collapse; }\n    th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-weight: bold; font-size: 14px; }\n    td { padding: 12px; }\n    .footer { text-align: center; color: #999; font-size: 12px; padding: 20px 0; border-top: 1px solid #eee; }\n    .warning { background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107; }\n    .warning strong { color: #856404; }\n    .warning ul { margin: 10px 0 0 0; padding-left: 20px; }\n    .warning li { margin: 5px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üîê Password Expiry Alert Report</h1>\n      <p>Generated: ${new Date().toLocaleString()}</p>\n    </div>\n    \n    <div class=\"summary\">\n      <div class=\"summary-card\">\n        <h3>Total Expiring</h3>\n        <div class=\"number\">${expiringCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #e74c3c;\">\n        <h3>Critical (‚â§3 days)</h3>\n        <div class=\"number\" style=\"color: #e74c3c;\">${criticalCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #c0392b;\">\n        <h3>Already Expired</h3>\n        <div class=\"number\" style=\"color: #c0392b;\">${expiredCount}</div>\n      </div>\n    </div>\n    \n    <div class=\"table-container\">\n      <h2>User Password Status</h2>\n      <table>\n        <thead>\n          <tr>\n            <th>Username</th>\n            <th>Full Name</th>\n            <th>Email</th>\n            <th>Status</th>\n            <th>Expiry Date</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${tableRows}\n        </tbody>\n      </table>\n    </div>\n    \n    <div class=\"warning\">\n      <strong>‚ö†Ô∏è Action Required:</strong>\n      <ul>\n        <li>Users with expiring passwords should reset them immediately</li>\n        <li>Expired passwords may result in account lockouts or login failures</li>\n        <li>Contact IT if unable to change password via self-service portal</li>\n        <li>IT Team: Verify script is running and users are receiving notifications</li>\n      </ul>\n    </div>\n    \n    <div class=\"footer\">\n      <p>This is an automated alert from Active Directory monitoring system.</p>\n      <p style=\"font-size: 11px; margin-top: 10px;\">If you believe this is in error, contact your IT department immediately.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nconsole.log('Built HTML email, user count:', expiringCount);\n\nreturn { json: { emailHtml: html, expiringCount: expiringCount, data: usersData } };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        176,
        1552
      ],
      "id": "512f7b04-81a0-4b18-bed4-c531ebcf4ed9",
      "name": "Build Email HTML"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 12
            }
          ]
        }
      },
      "id": "58000f4b-3a5c-4f60-858b-c1a8b8b44a52",
      "name": "Every 12 hours",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1,
      "position": [
        -1296,
        2208
      ]
    }
  ],
  "connections": {
    "Aggregate All Items": {
      "main": [
        [
          {
            "node": "Build Email HTML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Password Expiry Script": {
      "main": [
        [
          {
            "node": "Parse Password Expiry Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Password Expiry Data": {
      "main": [
        [
          {
            "node": "Check Memory",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Memory": {
      "main": [
        [
          {
            "node": "Aggregate All Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any expired/expiring?": {
      "main": [
        [
          {
            "node": "Send Email",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send Slack Alert",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Events",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Email HTML": {
      "main": [
        [
          {
            "node": "Any expired/expiring?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 12 hours": {
      "main": [
        [
          {
            "node": "Run Password Expiry Script",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "binaryMode": "separate",
    "availableInMCP": false,
    "timeSavedMode": "fixed",
    "timezone": "Asia/Jerusalem",
    "callerPolicy": "workflowsFromSameOwner"
  },
  "staticData": {
    "node:Every 6 hours": {
      "recurrenceRules": []
    },
    "node:Every 12 hours": {
      "recurrenceRules": []
    }
  },
  "meta": null,
  "pinData": {},
  "versionId": "848008f8-d86a-4a53-a4cb-7baadd3e9ba1",
  "activeVersionId": "848008f8-d86a-4a53-a4cb-7baadd3e9ba1",
  "triggerCount": 1,
  "shared": [
    {
      "updatedAt": "2026-02-12T12:50:02.601Z",
      "createdAt": "2026-02-12T12:50:02.601Z",
      "role": "workflow:owner",
      "workflowId": "Xy5FO273WkJQcpOO",
      "projectId": "pWTWmuHnmIHw48U9"
    }
  ],
  "activeVersion": {
    "updatedAt": "2026-02-12T15:16:29.000Z",
    "createdAt": "2026-02-12T15:15:46.870Z",
    "versionId": "848008f8-d86a-4a53-a4cb-7baadd3e9ba1",
    "workflowId": "Xy5FO273WkJQcpOO",
    "nodes": [
      {
        "parameters": {
          "aggregate": "aggregateAllItemData",
          "options": {}
        },
        "type": "n8n-nodes-base.aggregate",
        "typeVersion": 1,
        "position": [
          -96,
          2208
        ],
        "id": "52c21ff1-78d6-4cf6-be2b-2361a28db8de",
        "name": "Aggregate All Items"
      },
      {
        "parameters": {
          "command": "=powershell.exe -NoProfile -ExecutionPolicy Bypass -File \"C:/Scripts/AD-Password-Expiry.ps1\"",
          "cwd": "="
        },
        "id": "5a3097f1-8092-4e8e-9efe-f8fd78063d15",
        "name": "Run Password Expiry Script",
        "type": "n8n-nodes-base.ssh",
        "typeVersion": 1,
        "position": [
          -896,
          2208
        ],
        "credentials": {
          "sshPassword": {
            "id": "umWU43lA8b3R4GcA",
            "name": "SSH Password account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Debug: Log raw output\nconst rawStdout = $input.first().json.stdout;\nconsole.log('Raw stdout:', rawStdout);\nconsole.log('Stdout type:', typeof rawStdout);\nconsole.log('Stdout length:', rawStdout ? rawStdout.length : 0);\n\n// Check if we have any output\nif (!rawStdout || rawStdout.trim() === '') {\n  console.error('No output from PowerShell script');\n  return { json: { data: [], error: 'No output from script', debug: 'Empty stdout' } };\n}\n\nlet parsedData = null;\n\ntry {\n  // Try to parse as JSON\n  parsedData = JSON.parse(rawStdout);\n  console.log('Successfully parsed JSON:', parsedData);\n} catch (parseError) {\n  console.error('JSON parse failed:', parseError.message);\n  console.error('Attempted to parse:', rawStdout.substring(0, 500));\n  \n  // Try to extract JSON from mixed output\n  const jsonMatch = rawStdout.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    try {\n      parsedData = JSON.parse(jsonMatch[0]);\n      console.log('Extracted JSON from mixed output');\n    } catch (e) {\n      console.error('Failed to extract JSON:', e.message);\n      return { json: { data: [], error: 'Failed to parse JSON', raw: rawStdout.substring(0, 200) } };\n    }\n  } else {\n    return { json: { data: [], error: 'No JSON found in output', raw: rawStdout.substring(0, 200) } };\n  }\n}\n\n// Extract data array\nconst data = parsedData.Data || parsedData.data || [];\nconsole.log('Extracted data array, count:', data.length);\n\nif (!Array.isArray(data)) {\n  console.error('Data is not an array:', typeof data);\n  return { json: { data: [], error: 'Data is not an array' } };\n}\n\n// Return properly formatted items\nconst result = data.map((user, index) => {\n  console.log(`Processing user ${index}:`, user);\n  \n  return {\n    json: {\n      username: user.Username || user.username || '',\n      fullname: user.FullName || user.fullname || user.FullName || '',\n      email: user.Email || user.email || '',\n      expiryDate: user.ExpiryDate || user.expiryDate || '',\n      daysUntilExpiry: parseInt(user.DaysUntilExpiry || user.daysUntilExpiry || 0),\n      lastPasswordChange: user.LastPasswordChange || user.lastPasswordChange || '',\n      passwordNeverExpires: user.PasswordNeverExpires || user.passwordNeverExpires || false\n    }\n  };\n});\n\nconsole.log('Parsed result count:', result.length);\nif (result.length > 0) {\n  console.log('First result:', result[0]);\n}\n\nreturn result;"
        },
        "id": "c3e330fb-b264-4bdd-9f51-931f9ccb9c3a",
        "name": "Parse Password Expiry Data",
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -608,
          2208
        ]
      },
      {
        "parameters": {
          "jsCode": "const currentUsers = $input.all();\nconst staticData = $getWorkflowStaticData('global');\nstaticData.lastAlertedDate = staticData.lastAlertedDate || {};\n\nconst today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD\n\nreturn currentUsers.filter(item => {\n  const user = item.json.username;\n  const lastDate = staticData.lastAlertedDate[user];\n\n  // Only alert once per day\n  if (lastDate !== today) {\n    staticData.lastAlertedDate[user] = today;\n    return true;\n  }\n  return false;\n});"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          -336,
          2208
        ],
        "id": "4be33b04-75ec-4ca2-88e3-e2916fa01b0e",
        "name": "Check Memory"
      },
      {
        "parameters": {
          "conditions": {
            "number": [
              {
                "value1": "={{ Object.keys($json).length > 0 ? 1 : 0 }}",
                "operation": "larger"
              }
            ]
          }
        },
        "id": "6f401897-aaf0-4549-9a37-f229cd013e7a",
        "name": "Any expired/expiring?",
        "type": "n8n-nodes-base.if",
        "typeVersion": 1,
        "position": [
          608,
          1552
        ]
      },
      {
        "parameters": {},
        "id": "782b7ce2-6b99-4318-bd51-aa75c5e414db",
        "name": "No Events",
        "type": "n8n-nodes-base.noOp",
        "typeVersion": 1,
        "position": [
          784,
          2240
        ]
      },
      {
        "parameters": {
          "select": "channel",
          "channelId": {
            "__rl": true,
            "value": "C0AE6LM59QF",
            "mode": "id"
          },
          "text": "=üîê *PASSWORD EXPIRY ALERT* (Total: {{ $json.data.length }})\n_________________________________________\n\n{{ $json.data.map(user => {\n  const daysLeft = user.daysUntilExpiry || 0;\n  const emoji = daysLeft <= 0 ? '‚õî' : (daysLeft <= 3 ? 'üî¥' : (daysLeft <= 7 ? 'üü†' : 'üü°'));\n  const username = user.username || 'N/A';\n  const fullname = user.fullname || 'N/A';\n  const expiryDate = user.expiryDate || 'N/A';\n  \nreturn `${emoji} *${fullname}*\nüÜî Username: \\`${username}\\`\nüìÖ Expires: ${expiryDate}\n‚è±Ô∏è Days Left: *${daysLeft}*`;\n}).join('\\n\\n') }}\n\n_________________________________________\n‚ö†Ô∏è *Action:* _Users should change their passwords before expiry. Expired accounts may be locked out._\n",
          "otherOptions": {}
        },
        "id": "ba1026ee-7e54-47d7-b612-c082361f1898",
        "name": "Send Slack Alert",
        "type": "n8n-nodes-base.slack",
        "typeVersion": 2.4,
        "position": [
          800,
          2048
        ],
        "webhookId": "ffc3f21e-c64d-4948-b8c2-f33c999ea7d7",
        "credentials": {
          "slackApi": {
            "id": "D411sZ9Jy82H8sJ8",
            "name": "Slack Password Bot"
          }
        }
      },
      {
        "parameters": {
          "sendTo": "vinokura@alex-it.net",
          "subject": "={{ \"üîê ALERT: \" + $json.expiringCount + \" Password(s) Expiry Alert!\" }}",
          "message": "={{ $json.emailHtml }}",
          "options": {}
        },
        "id": "e610b00f-7b26-4546-9921-67f4d9a921eb",
        "name": "Send Email",
        "type": "n8n-nodes-base.gmail",
        "typeVersion": 2,
        "position": [
          816,
          1840
        ],
        "webhookId": "4daed7dc-3119-4155-8779-07b60b01ea00",
        "credentials": {
          "gmailOAuth2": {
            "id": "C5742Grqr9Rpnxid",
            "name": "Gmail account"
          }
        }
      },
      {
        "parameters": {
          "jsCode": "// Safely extract and aggregate data\nconst allItems = $input.all();\nconsole.log('Input items:', allItems.length);\n\nif (!allItems || allItems.length === 0) {\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Get the aggregated data\nconst firstItem = allItems[0].json;\nconsole.log('First item structure:', Object.keys(firstItem));\n\n// If data is already aggregated in json.data array\nlet usersData = [];\nif (firstItem.data && Array.isArray(firstItem.data)) {\n  usersData = firstItem.data;\n  console.log('Got users from data array:', usersData.length);\n} else if (firstItem.username) {\n  // Individual user items\n  usersData = allItems.map(item => item.json);\n  console.log('Got users from individual items:', usersData.length);\n}\n\nif (!usersData || usersData.length === 0) {\n  console.error('No user data found');\n  return { json: { data: [], emailHtml: '', expiringCount: 0 } };\n}\n\n// Build HTML table\nconst tableRows = usersData.map(user => {\n  const daysLeft = parseInt(user.daysUntilExpiry || user.DaysUntilExpiry || 0);\n  const statusColor = daysLeft <= 0 ? '#e74c3c' : (daysLeft <= 3 ? '#e67e22' : (daysLeft <= 7 ? '#f39c12' : '#27ae60'));\n  const statusText = daysLeft <= 0 ? 'EXPIRED' : `${daysLeft} Days`;\n  const username = user.username || user.Username || '';\n  const fullname = user.fullname || user.FullName || '';\n  const email = user.email || user.Email || 'N/A';\n  const expiryDate = user.expiryDate || user.ExpiryDate || 'N/A';\n  \n  console.log(`Building row for ${username}: ${daysLeft} days`);\n  \n  return `\n    <tr style=\"border-bottom: 1px solid #eee;\">\n      <td style=\"padding: 12px; font-weight: 500;\">${username}</td>\n      <td style=\"padding: 12px;\">${fullname}</td>\n      <td style=\"padding: 12px;\">${email}</td>\n      <td style=\"padding: 12px; color: white; font-weight: bold; background-color: ${statusColor}; border-radius: 4px; text-align: center;\">\n        ${statusText}\n      </td>\n      <td style=\"padding: 12px;\">${expiryDate}</td>\n    </tr>`;\n}).join('');\n\nconst expiringCount = usersData.length;\nconst criticalCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 3).length;\nconst expiredCount = usersData.filter(u => (parseInt(u.daysUntilExpiry || u.DaysUntilExpiry || 0)) <= 0).length;\n\nconst html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }\n    .header { background-color: #2c3e50; color: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .header h1 { margin: 0; font-size: 24px; }\n    .header p { margin: 5px 0 0 0; opacity: 0.9; }\n    .summary { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }\n    .summary-card { background: white; padding: 15px; border-radius: 4px; border-left: 4px solid #3498db; }\n    .summary-card h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; text-transform: uppercase; }\n    .summary-card .number { font-size: 32px; font-weight: bold; color: #2c3e50; }\n    .table-container { background: white; padding: 20px; border-radius: 4px; margin-bottom: 20px; }\n    .table-container h2 { margin: 0 0 15px 0; font-size: 18px; color: #2c3e50; }\n    table { width: 100%; border-collapse: collapse; }\n    th { background-color: #34495e; color: white; padding: 12px; text-align: left; font-weight: bold; font-size: 14px; }\n    td { padding: 12px; }\n    .footer { text-align: center; color: #999; font-size: 12px; padding: 20px 0; border-top: 1px solid #eee; }\n    .warning { background: #fff3cd; padding: 15px; border-radius: 4px; margin-bottom: 20px; border-left: 4px solid #ffc107; }\n    .warning strong { color: #856404; }\n    .warning ul { margin: 10px 0 0 0; padding-left: 20px; }\n    .warning li { margin: 5px 0; }\n  </style>\n</head>\n<body>\n  <div class=\"container\">\n    <div class=\"header\">\n      <h1>üîê Password Expiry Alert Report</h1>\n      <p>Generated: ${new Date().toLocaleString()}</p>\n    </div>\n    \n    <div class=\"summary\">\n      <div class=\"summary-card\">\n        <h3>Total Expiring</h3>\n        <div class=\"number\">${expiringCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #e74c3c;\">\n        <h3>Critical (‚â§3 days)</h3>\n        <div class=\"number\" style=\"color: #e74c3c;\">${criticalCount}</div>\n      </div>\n      <div class=\"summary-card\" style=\"border-left-color: #c0392b;\">\n        <h3>Already Expired</h3>\n        <div class=\"number\" style=\"color: #c0392b;\">${expiredCount}</div>\n      </div>\n    </div>\n    \n    <div class=\"table-container\">\n      <h2>User Password Status</h2>\n      <table>\n        <thead>\n          <tr>\n            <th>Username</th>\n            <th>Full Name</th>\n            <th>Email</th>\n            <th>Status</th>\n            <th>Expiry Date</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${tableRows}\n        </tbody>\n      </table>\n    </div>\n    \n    <div class=\"warning\">\n      <strong>‚ö†Ô∏è Action Required:</strong>\n      <ul>\n        <li>Users with expiring passwords should reset them immediately</li>\n        <li>Expired passwords may result in account lockouts or login failures</li>\n        <li>Contact IT if unable to change password via self-service portal</li>\n        <li>IT Team: Verify script is running and users are receiving notifications</li>\n      </ul>\n    </div>\n    \n    <div class=\"footer\">\n      <p>This is an automated alert from Active Directory monitoring system.</p>\n      <p style=\"font-size: 11px; margin-top: 10px;\">If you believe this is in error, contact your IT department immediately.</p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nconsole.log('Built HTML email, user count:', expiringCount);\n\nreturn { json: { emailHtml: html, expiringCount: expiringCount, data: usersData } };"
        },
        "type": "n8n-nodes-base.code",
        "typeVersion": 2,
        "position": [
          176,
          1552
        ],
        "id": "512f7b04-81a0-4b18-bed4-c531ebcf4ed9",
        "name": "Build Email HTML"
      },
      {
        "parameters": {
          "rule": {
            "interval": [
              {
                "field": "hours",
                "hoursInterval": 12
              }
            ]
          }
        },
        "id": "58000f4b-3a5c-4f60-858b-c1a8b8b44a52",
        "name": "Every 12 hours",
        "type": "n8n-nodes-base.scheduleTrigger",
        "typeVersion": 1,
        "position": [
          -1296,
          2208
        ]
      }
    ],
    "connections": {
      "Aggregate All Items": {
        "main": [
          [
            {
              "node": "Build Email HTML",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Run Password Expiry Script": {
        "main": [
          [
            {
              "node": "Parse Password Expiry Data",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Parse Password Expiry Data": {
        "main": [
          [
            {
              "node": "Check Memory",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Check Memory": {
        "main": [
          [
            {
              "node": "Aggregate All Items",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Any expired/expiring?": {
        "main": [
          [
            {
              "node": "Send Email",
              "type": "main",
              "index": 0
            },
            {
              "node": "Send Slack Alert",
              "type": "main",
              "index": 0
            }
          ],
          [
            {
              "node": "No Events",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Build Email HTML": {
        "main": [
          [
            {
              "node": "Any expired/expiring?",
              "type": "main",
              "index": 0
            }
          ]
        ]
      },
      "Every 12 hours": {
        "main": [
          [
            {
              "node": "Run Password Expiry Script",
              "type": "main",
              "index": 0
            }
          ]
        ]
      }
    },
    "authors": "Alex Vinokur",
    "name": "Version 848008f8",
    "description": "",
    "autosaved": true
  },
  "tags": []
}